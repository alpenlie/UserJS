// ==UserScript==
// @name	Tieba Float Movable
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	http://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.1.3
// @description	贴吧可移动悬浮窗
// @homepage	http://userscripts.org/scripts/show/156576
// @downloadURL	https://userscripts.org/scripts/source/156576.user.js
// @updateURL	https://userscripts.org/scripts/source/156576.meta.js
// @include	http://tieba.baidu.com/*
// @exclude	http://tieba.baidu.com/tb/*
// @require	https://raw.github.com/gera2ld/UserJS/master/lib/TiebaCommon.min.user.js
// @grant	GM_getValue
// @grant	GM_setValue
// @grant	GM_registerMenuCommand
// ==/UserScript==
function t(t,e){var i={};x.forEach(function(t){i[t]=/^-?\d+px/.test(e[t])?e[t]:"20px"}),t.css(i)}function e(e,i){var o=$(e);o.mousedown&&(e.moving=!1,x=["right","bottom"],o.mousedown(function(n){["DIV","TD"].indexOf(n.target.tagName)<0||n.target.contentEditable=="true"||(n.preventDefault(),n.stopPropagation(),e.x=n.pageX,x.indexOf("left")>=0?e.x-=parseInt(o.css("left")):e.x+=parseInt(o.css("right")),e.y=n.pageY,x.indexOf("top")>=0?e.y-=parseInt(o.css("top")):e.y+=parseInt(o.css("bottom")),e.moving||$(document).mousemove(function(i){if(e.moving){var n={};for(var a in x){var r=x[a];if("left"==r)n[r]=i.pageX-e.x;else if("right"==r)n[r]=e.x-i.pageX;else if("top"==r)n[r]=i.pageY-e.y;else{if("bottom"!=r)continue;n[r]=e.y-i.pageY}n[r]+="px"}t(o,n)}i.preventDefault()}).mouseup(function(){if(e.moving){e.moving=!1;var t={};for(var n in x){var a=x[n];t[a]=o.css(a)}utils.setObj("mcss_"+i,t),$(document).unbind("mousemove").unbind("mouseup")}}),e.moving=!0)}),t(o,utils.getObj("mcss_"+i,{})))}function i(t){$(t).unbind("mousedown").css({left:"",right:"",top:"",bottom:""})}function o(){y.hide(),m.show()}function n(){m.hide(),y.show()}function a(t){t&&(c=t.type=="dblclick"?"open"==c?"close":"open":"normal"==c?"open":"normal",utils.setObj("float",c)),t&&t.type!="click"||("normal"==c?(d.html(""),s.html(""),f.val("悬浮"),m.unbind("dblclick"),i(m[0]),m.prop("title",""),u.attr("style",h),_.hide()):(d.html(p),f.val("停靠"),m.dblclick(a),e(m[0],"float"),u.prop("style",""),b?(n(),_.show()):(o(),_.hide()))),g&&"open"!=c?"close"==c&&(s.html("#edit_parent{width:360px;}#edit_parent *{max-width:360px;}.tb-editor-toolbar,#signNameWrapper,.pt_submit,.editor_users{display:none;}.tb-editor-wrapper{margin:0 !important}.tb-editor-editarea{min-height:24px !important;}.editor_tip_show{top:0 !important;left:60px !important;}.edit_title_field{padding:0 !important;}"),m.attr("title","双击展开")):(s.html("#edit_parent{width:635px;}#edit_parent *{max-width:635px;}.tb-editor-editarea{min-height:50px !important;}.editor_tip_show{top:50px !important}"),g&&m.attr("title","双击精简"))}function r(){utils.popup.show({html:"<h3>贴吧悬浮窗脚本设置</h3><label><input type=checkbox id=allowMinify>自动隐藏悬浮窗口到右下角</label><label><br><input type=checkbox id=allowSimple>双击悬浮窗口使其精简或展开</label><br><button id=btReset>重置悬浮窗位置</button>",className:"ge_opt",init:function(e){e.querySelector("#btReset").onclick=function(){t(m,{})};var i=e.querySelector("#allowMinify");i.checked=b,i.onchange=function(){utils.setObj("allowMinify",b=this.checked)},i=e.querySelector("#allowSimple"),i.checked=g,i.onchange=function(){utils.setObj("allowSimple",g=this.checked)}},dispose:function(){a()}})}function l(t){(t=unsafeWindow.rich_postor._editor.editorPlugins.idisk)&&(t=t.overlay,t.$holder.css("display","none"),utils.hook(t,"open",{before:function(){this.$holder.css("display","")}}),utils.hook(t,"close",{before:function(){this.$holder.css("display","none")}}))}if(PageData&&PageData.user&&unsafeWindow.rich_postor){var p="#signNameWrapper{margin:0 !important;}#edit_parent{border:3px double grey;position:fixed !important;z-index:998;background-color:#E7EAEB;}#edit_parent>table td:first-child,.new_tiezi_tip{display:none;}.editor_users{padding:0 !important;}.subTip,.e_inter_wrapper{display:none;}.edit_title_field{margin:0 0 -5px !important;}.tb-editor-editarea{max-height:266px !important;}",s=utils.addStyle(),d=utils.addStyle(),c=utils.getObj("float","normal"),u=$(unsafeWindow.rich_postor._editor.editArea),m=$("#edit_parent"),h=u.attr("style"),f=utils.addSButton().click(a),b=utils.getObj("allowMinify",!0),g=utils.getObj("allowSimple",!0),x,y=$('<div style="position:fixed;bottom:0;right:0;background:white;padding-top:40px;">◀</div>').appendTo(document.body).hide().mouseover(o),_=$('<div style="position:absolute;top:0;background:inherit;border:1px solid gray;padding-bottom:40px;cursor:pointer;" title="最小化">▶</div>').appendTo(m).hide().click(n);_.css("left",-_.outerWidth()),a(),l(),GM_registerMenuCommand("悬浮窗设置",r),notice(1,"欢迎使用贴吧悬浮窗脚本！\n功能简介：\n1. 可悬浮编辑窗，悬浮后可移动；\n2. 双击悬浮窗口框架可展开或精简编辑框；\n3. 悬浮窗口支持自动隐藏到右下角，鼠标移至右下角即可呼出。")}