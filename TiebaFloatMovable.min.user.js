// ==UserScript==
// @name	Tieba Float Movable
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	http://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.1
// @description	贴吧可移动悬浮窗
// @homepage	https://userscripts.org/scripts/show/156576
// @downloadURL	https://userscripts.org/scripts/source/156576.user.js
// @updateURL	https://userscripts.org/scripts/source/156576.meta.js
// @include	http://tieba.baidu.com/*
// @exclude	http://tieba.baidu.com/tb/*
// @require	https://raw.github.com/gera2ld/UserJS/master/lib/TiebaCommon.min.user.js
// @grant	GM_registerMenuCommand
// ==/UserScript==
function t(t,i){var e={};t.args.forEach(function(t){e[t]=/^-?\d+px/.test(i[t])?i[t]:"20px"}),$(t).css(e)}function i(i,e){$(i).mousedown&&(i.moving=!1,i.args=[$(i).css("left")=="auto"?"right":"left",$(i).css("top")=="auto"?"bottom":"top"],$(i).mousedown(function(o){["DIV","TD"].indexOf(o.target.tagName)<0||o.target.contentEditable=="true"||(o.preventDefault(),o.stopPropagation(),this.x=o.pageX,this.args.indexOf("left")>=0?this.x-=parseInt($(this).css("left")):this.x+=parseInt($(this).css("right")),this.y=o.pageY,this.args.indexOf("top")>=0?this.y-=parseInt($(this).css("top")):this.y+=parseInt($(this).css("bottom")),this.moving||$(document).mousemove(function(e){if(i.moving){var o={};for(var n in i.args){var a=i.args[n];if("left"==a)o[a]=e.pageX-i.x;else if("right"==a)o[a]=i.x-e.pageX;else if("top"==a)o[a]=e.pageY-i.y;else{if("bottom"!=a)continue;o[a]=i.y-e.pageY}o[a]+="px"}t(i,o)}e.preventDefault()}).mouseup(function(){if(i.moving){i.moving=!1;var t={};for(var o in i.args){var n=i.args[o];t[n]=$(i).css(n)}utils.setObj("mcss_"+e,t),$(document).unbind("mousemove").unbind("mouseup")}}),this.moving=!0)}),t(i,utils.getObj("mcss_"+e,{})))}function e(t){$(t).unbind("mousedown").css({left:"",right:"",top:"",bottom:""})}function o(){g.hide(),m.show()}function n(){m.hide(),g.show()}function a(t){t&&(d=t.type=="dblclick"?"open"==d?"close":"open":"normal"==d?"open":"normal",utils.setObj("float",d)),t&&t.type!="click"||("normal"==d?(p.html(""),s.html(""),c.val("悬浮"),m.unbind("dblclick"),e(m[0]),m.prop("title",null),l.attr("style",u)):(p.html(r),c.val("停靠"),m.dblclick(a),i(m[0],"float"),l.prop("style",null),f&&n())),b&&"open"!=d?"close"==d&&(s.html("#edit_parent{width:360px;}#edit_parent *{max-width:360px;}.tb-editor-toolbar,#signNameWrapper,.pt_submit,.editor_users{display:none;}.tb-editor-wrapper{margin:0 !important}.tb-editor-editarea{min-height:24px !important;}.editor_tip_show{top:0 !important;left:60px !important;}.edit_title_field{padding:0 !important;}"),m.attr("title","双击展开")):(s.html("#edit_parent{width:635px;}#edit_parent *{max-width:635px;}.tb-editor-editarea{min-height:50px !important;}.editor_tip_show{top:50px !important}"),b&&m.attr("title","双击收缩"))}if(PageData&&PageData.user&&unsafeWindow.rich_postor){var r="#signNameWrapper{margin:0 !important;}#edit_parent{border:3px double grey;position:fixed;z-index:998;background-color:#E7EAEB;}#edit_parent>table td:first-child,.new_tiezi_tip{display:none;}.editor_users{padding:0 !important;}.subTip,.e_inter_wrapper{display:none;}.edit_title_field{margin:0 0 -5px !important;}.tb-editor-editarea{max-height:266px !important;}",s=utils.addStyle(),p=utils.addStyle(),d=utils.getObj("float","normal"),l=$(unsafeWindow.rich_postor._editor.editArea),m=$("#edit_parent"),u=l.attr("style"),c=utils.addSButton().click(a),g,h,f=!0,b=!0;f&&(g=$('<div style="position:fixed;bottom:0;right:0;background:white;padding-top:40px;">◄</div>').appendTo(document.body).hide().mouseover(o),h=$('<div style="position:absolute;top:0;background:inherit;border:1px solid gray;padding-bottom:40px;cursor:pointer;" title="最小化">►</div>').appendTo(m).click(n),h.css("left",-h.outerWidth())),a(),GM_registerMenuCommand("重置悬浮窗",function(){t(m[0],{})})}