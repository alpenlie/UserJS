// ==UserScript==
// @name	Baidu Multiuser
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	https://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.3
// @description	百度马甲切换
// @homepage	https://userscripts.org/scripts/show/160577
// @downloadURL	https://userscripts.org/scripts/source/160577.user.js
// @updateURL	https://userscripts.org/scripts/source/160577.meta.js
// @match	*://*.baidu.com/*
// @include	*.baidu.com/*
// @grant	GM_getValue
// @grant	GM_setValue
// @grant	GM_addStyle
// @grant	GM_openInTab
// ==/UserScript==
function e(e,t){var o=GM_getValue("notice")||0;e>o&&(alert(t),GM_setValue("notice",e))}function t(e,t){var o=new Date;e?o.setTime(16094e8):e="",document.cookie="BDUSS="+e+";domain=baidu.com;path=/;expires="+o.toGMTString(),"function"==typeof t?t():"string"==typeof t?location.replace(t):location.reload()}function o(){y.right=y._right=y.parentNode.offsetWidth-y.offsetWidth-y.offsetLeft,y.top=y._top=y.offsetTop}function n(){GM_setValue("ge_users",JSON.stringify(x))}function i(){GM_setValue("ge_users_loc",JSON.stringify({right:y.right,top:y.top}))}function s(e,o,i){e.preventDefault(),i=e.target,i.tagName=="A"?(i=i.parentNode,o=i.parentNode,i==o.firstChild?t():i==o.lastChild?GM_openInTab("https://passport.baidu.com/v2/?login&tpl=mn&u="+encodeURIComponent("http://www.baidu.com/")):(i=i.firstChild,t(x[i.innerText||i.textContent],/^\/i\//.test(location.pathname)&&"/"))):i.tagName=="SPAN"&&(o=i.previousSibling,delete x[o.innerText||o.textContent],setTimeout(n,0),o=o.parentNode,o.parentNode.removeChild(o))}function a(e){e&&(y.right=e&&!isNaN(e.right)?e.right:100,y.top=e&&!isNaN(e.top)?e.top:100),y.style.right=y.right+"px",y.style.top=y.top+"px"}function r(e){e.preventDefault(),e.stopPropagation();var t={right:y._right+y.x-e.pageX,top:y._top+e.pageY-y.y};a(t)}function p(){b.innerHTML=y.pin?"●":"○",b.setAttribute("title",y.pin?"固定在页面上":"固定在屏幕上"),y.style.position=y.pin?"absolute":""}function l(){o(),y.pin?y.top+=window.pageYOffset:y.top-=window.pageYOffset,p(),a(),i()}function u(e){GM_addStyle("#ge_users{display:block;position:fixed;padding:10px;text-align:left;}#ge_users,.ge_users,.ge_popup{z-index:10006;font:normal normal 400 12px/18px 宋体;}#ge_users>span{background:white;color:blue;border-radius:3px;border:1px solid #c0c0c0;padding:2px;cursor:pointer;}#ge_users>div{position:relative;margin-top:3px;}.ge_users,.ge_popup{display:none;background:white;border:1px solid silver;box-shadow:5px 5px 7px #333;}.ge_popup{padding:20px;position:fixed;border-radius:5px;}.ge_popup fieldset{border:1px solid silver;border-radius:5px;padding:5px;}.ge_popup textarea{min-height:100px;}.ge_users{position:absolute;width:120px;max-height:400px;overflow-x:hidden;overflow-y:auto;}.ge_users>li{position:relative;display:block;padding:2px 20px 4px 6px;}.ge_users>li:hover{background:lightgray;}.ge_users a{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}.ge_users span{position:absolute;top:0;right:0;color:white;background:#77f;border-radius:3px;margin:2px;cursor:pointer;padding:2px;}"),y=document.createElement("div"),y.id="ge_users",y.innerHTML="<span>马甲<span></span></span><div><ul class=ge_users></ul></div>",y.style.display=GM_getValue("float")||"",v=y.querySelector("ul"),v.onclick=s,b=y.firstChild.lastChild,y.pin=!!GM_getValue("ge_pin"),p(),b.onclick=function(){GM_setValue("ge_pin",y.pin=!y.pin),l()},y.onmouseover=function(e){this.contains(e.relatedTarget)||(v.style.display="block",v.style.pixelLeft=y.offsetLeft+y.firstChild.offsetLeft+v.offsetWidth<=document.body.offsetWidth?0:document.body.offsetWidth-y.offsetLeft-y.firstChild.offsetLeft-v.offsetWidth)},y.onmouseout=function(e){this.contains(e.relatedTarget)||(v.style.display="")};try{e=JSON.parse(GM_getValue("ge_users_loc"))}catch(t){e={}}document.body.appendChild(y),a(e),y.moving=!1,y.firstChild.onmousedown=function(e){e.preventDefault(),e.stopPropagation(),e.target!=y.firstChild||y.moving||(y.moving=!0,o(),y.x=e.pageX,y.y=e.pageY,document.addEventListener("mousemove",r,!1))},y.onmouseup=function(e){y.moving&&(y.moving=!1,e.preventDefault(),e.stopPropagation(),document.removeEventListener("mousemove",r,!1),i())},e=["<li><a href=#>未登录状态</a></li>"];for(var n in x)n?e.push("<li><a href=#>"+n.replace(/&/g,"&amp;").replace(/</g,"&lt;")+"</a><span>删</span></li>"):delete x[n];e.push("<li><a href=#>添加马甲</a></li>"),v.innerHTML=e.join(""),M=document.createElement("div"),document.body.appendChild(M)}function d(e){M.contains(e.target)||(M.innerHTML="",M.style.display="",document.removeEventListener("mousedown",d,!1))}function f(){M.style.display="block",document.addEventListener("mousedown",d,!1),M.style.top=(innerHeight-M.offsetHeight)/2+"px",M.style.left=(innerWidth-M.offsetWidth)/2+"px"}function g(e,t){(e=unsafeWindow.PageData)&&e.user&&e.user.is_login&&e.user.name?e=e.user.name:(e=document.getElementById("s_username_top"))&&(e=e.innerText||e.textContent),e&&(t=document.cookie.match(/BDUSS=(.*?)(;|$)/),t&&(x[e]=t[1],n()))}function c(){M.innerHTML=v.innerHTML,M.className="ge_users",f()}function h(){y.style.display=y.style.display==""?"none":"",GM_setValue("float",y.style.display)}function m(){M.innerHTML='<h3>设置 - 百度马甲切换脚本</h3><label><input type=checkbox id=gu_showfloat>显示悬浮图标</label><br><fieldset><legend>马甲数据 <button id=gu_import>导入</button> <button id=gu_export>导出</button> <a title="复制数据到以下文本框然后点击导入即可导入数据。\n点击导出后复制数据文本即可用于导入。">(?)</a></legend><textarea id=gu_data></textarea></fieldset>';var e=M.querySelector("#gu_showfloat");e.checked=GM_getValue("float")!="none",e.onchange=function(){setTimeout(h,0)};var t=M.querySelector("#gu_data");t.onfocus=function(){t.select()},M.querySelector("#gu_import").onclick=function(){try{e=JSON.parse(t.value)}catch(o){e=null}e&&"object"==typeof e?(x=e,n(),alert("导入成功！")):alert("导入失败！")},M.querySelector("#gu_export").onclick=function(){t.value=JSON.stringify(x)},M.className="ge_popup",f()}if(window.top===window){var _,x,y,v,b,w,M=null;x=GM_getValue("ge_users"),x=x?JSON.parse(x):{},g(),u(),GM_registerMenuCommand("马甲脚本设置",m),GM_registerMenuCommand("切换马甲（Shift+M）",c),window.addEventListener("keydown",function(e){if(e.target==document.body){if(!e.shiftKey||e.keyCode!=77)return;c(),e.preventDefault()}},!1),e(1,"欢迎使用百度马甲切换脚本！\n功能特点：\n1. “马甲”可以拖动。\n2. 切换固定方式：固定在页面（可随页面滚动）或固定在屏幕。\n3. 扩展菜单中可打开脚本设置面板，支持数据导入导出。\n4. 扩展菜单中呼出或使用快捷键Shift+M呼出马甲切换面板。\n　　　　　　　　　　　--Gerald <gera2ld@163.com>")}