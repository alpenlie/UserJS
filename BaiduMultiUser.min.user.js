// ==UserScript==
// @name	Baidu Multiuser
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	http://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.3.5.2
// @description	百度马甲切换
// @homepage	http://userscripts.org/scripts/show/160577
// @downloadURL	https://userscripts.org/scripts/source/160577.user.js
// @updateURL	https://userscripts.org/scripts/source/160577.meta.js
// @match	*://*.baidu.com/*
// @include	*.baidu.com/*
// @require	https://raw.github.com/gera2ld/UserJS/master/lib/TiebaCommon.min.user.js
// @grant	GM_getValue
// @grant	GM_setValue
// @grant	GM_openInTab
// @grant	GM_registerMenuCommand
// ==/UserScript==
function e(e,t){var o=new Date;e?o.setTime(16094e8):e="",document.cookie="BDUSS="+e+";domain=baidu.com;path=/;expires="+o.toGMTString(),"function"==typeof t?t():"string"==typeof t?location.replace(t):location.reload()}function t(){m.right=m._right=m.parentNode.offsetWidth-m.offsetWidth-m.offsetLeft,m.top=m._top=m.offsetTop}function o(){GM_setValue("ge_users",JSON.stringify(v))}function i(){GM_setValue("ge_users_loc",JSON.stringify({right:m.right,top:m.top}))}function n(t,i,n){t.preventDefault(),n=t.target,n.tagName=="A"?(n=n.parentNode,i=n.parentNode,n==i.firstChild?e():n==i.lastChild?GM_openInTab("https://passport.baidu.com/v2/?login&tpl=mn&u="+encodeURIComponent("http://www.baidu.com/")):(n=n.firstChild,e(v[n.innerText||n.textContent],/^\/i\//.test(location.pathname)&&"/"))):n.tagName=="SPAN"&&(i=n.previousSibling,delete v[i.innerText||i.textContent],setTimeout(o,0),i=i.parentNode,i.parentNode.removeChild(i))}function a(e){e&&(m.right=e&&!isNaN(e.right)?e.right:100,m.top=e&&!isNaN(e.top)?e.top:100),m.style.right=m.right+"px",m.style.top=m.top+"px"}function s(e){e.preventDefault(),e.stopPropagation();var t={right:m._right+m.x-e.pageX,top:m._top+e.pageY-m.y};a(t)}function r(){y.innerHTML=m.pin?"●":"○",y.setAttribute("title",m.pin?"固定在页面上":"固定在屏幕上"),m.style.position=m.pin?"absolute":""}function l(){t(),m.pin?m.top+=window.pageYOffset:m.top-=window.pageYOffset,r(),a(),i()}function p(e){utils.addStyle("#ge_u{display:block;padding:10px;text-align:left;}#ge_u .ge_h{display:none;}#ge_u{z-index:10006;font:normal normal 400 12px/18px 宋体;position:fixed;}#ge_u>span{background:white;color:blue;border-radius:3px;border:1px solid #c0c0c0;padding:2px;cursor:pointer;}#ge_u>div{position:relative;margin-top:3px;}#ge_u>div>*{position:absolute;}.ge_u{background:white;border:1px solid silver;box-shadow:5px 5px 7px #333;}.ge_u{width:120px;max-height:400px;overflow-x:hidden;overflow-y:auto;}.ge_u>li{position:relative;display:block;padding:2px 20px 4px 6px;}.ge_u>li:hover{background:lightgray;}.ge_u a{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}.ge_u span{position:absolute;top:0;right:0;color:white;background:#77f;border-radius:3px;margin:2px;cursor:pointer;padding:2px;}"),m=document.createElement("div"),m.id="ge_u",m.innerHTML='<span>马甲<span></span></span><div><ul class="ge_u ge_h"></ul></div>',m.style.display=GM_getValue("float")||"",_=m.querySelector("ul"),_.onclick=n,y=m.firstChild.lastChild,m.pin=!!GM_getValue("ge_pin"),r(),y.onclick=function(){GM_setValue("ge_pin",m.pin=!m.pin),l()},m.onmouseover=function(e){this.contains(e.relatedTarget)||(_.classList.remove("ge_h"),_.style.pixelLeft=m.offsetLeft+m.firstChild.offsetLeft+_.offsetWidth<=document.body.offsetWidth?0:document.body.offsetWidth-m.offsetLeft-m.firstChild.offsetLeft-_.offsetWidth)},m.onmouseout=function(e){this.contains(e.relatedTarget)||_.classList.add("ge_h")};try{e=JSON.parse(GM_getValue("ge_users_loc"))}catch(o){e={}}document.body.appendChild(m),a(e),m.moving=!1,m.firstChild.onmousedown=function(e){e.preventDefault(),e.stopPropagation(),e.target!=m.firstChild||m.moving||(m.moving=!0,t(),m.x=e.pageX,m.y=e.pageY,document.addEventListener("mousemove",s,!1))},m.onmouseup=function(e){m.moving&&(m.moving=!1,e.preventDefault(),e.stopPropagation(),document.removeEventListener("mousemove",s,!1),i())},u()}function u(){d=["<li><a href=#>未登录状态</a></li>"];for(var e in v)e?d.push("<li><a href=#>"+e.replace(/&/g,"&amp;").replace(/</g,"&lt;")+"</a><span>删</span></li>"):delete v[e];d.push("<li><a href=#>添加马甲</a></li>"),_.innerHTML=d.join("")}function c(e,t){(e=unsafeWindow.PageData)&&e.user&&e.user.is_login&&e.user.name?e=e.user.name:(e=unsafeWindow.s_session)&&(e=e.username),e&&(t=document.cookie.match(/BDUSS=(.*?)(;|$)/),t&&(v[e]=t[1],o()))}function f(){utils.popup.show({html:_.innerHTML,className:"ge_u",init:function(e){_.style.display="none",e.onclick=n},dispose:function(e){_.style.display="",e.onclick=null,u()}})}function g(){utils.popup.show({html:'<h3>设置 - 百度马甲切换脚本</h3><label><input type=checkbox id=gu_showfloat>显示悬浮图标</label><br><fieldset><legend>马甲数据 <button id=gu_import>导入</button> <button id=gu_export>导出</button> <a title="复制数据到以下文本框然后点击导入即可导入数据。\n点击导出后复制数据文本即可用于导入。">(?)</a></legend><textarea id=gu_data></textarea></fieldset>',className:"ge_opt",init:function(e){var t=e.querySelector("#gu_showfloat");t.checked=GM_getValue("float")!="none",t.onchange=function(){m.style.display=this.checked?"":"none",GM_setValue("float",m.style.display)},t=e.querySelector("#gu_data"),t.onclick=function(){this.select()},e.querySelector("#gu_import").onclick=function(e){try{e=JSON.parse(t.value)}catch(i){e=null}e&&"object"==typeof e?(v=e,o(),u(),alert("导入成功！")):alert("导入失败！")},e.querySelector("#gu_export").onclick=function(){t.value=JSON.stringify(v)}}})}if(window.top===window&&document.head){var h,m,_,y,x,v=GM_getValue("ge_users");v=v?JSON.parse(v):{},c(),p(),GM_registerMenuCommand("马甲脚本设置",g),GM_registerMenuCommand("切换马甲（Shift+M）",f),window.addEventListener("keydown",function(e){if(e.target==document.body){if(!e.shiftKey||e.keyCode!=77)return;f(),e.preventDefault()}},!1),notice(1,"欢迎使用百度马甲切换脚本！\n功能特点：\n1. “马甲”可以拖动。\n2. 切换固定方式：固定在页面（可随页面滚动）或固定在屏幕。\n3. 扩展菜单中可打开脚本设置面板，支持数据导入导出。\n4. 扩展菜单中呼出或使用快捷键Shift+M呼出马甲切换面板。\n　　　　　　　--Gerald <gera2ld@163.com>")}