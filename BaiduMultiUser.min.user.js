// ==UserScript==
// @name	Baidu Multiuser
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	https://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.3.3
// @description	百度马甲切换
// @homepage	https://userscripts.org/scripts/show/160577
// @downloadURL	https://userscripts.org/scripts/source/160577.user.js
// @updateURL	https://userscripts.org/scripts/source/160577.meta.js
// @match	*://*.baidu.com/*
// @include	*.baidu.com/*
// @grant	GM_getValue
// @grant	GM_setValue
// @grant	GM_addStyle
// @grant	GM_openInTab
// @grant	GM_registerMenuCommand
// ==/UserScript==
function e(e,t){var o=GM_getValue("notice")||0;e>o&&(alert(t),GM_setValue("notice",e))}function t(e,t){var o=new Date;e?o.setTime(16094e8):e="",document.cookie="BDUSS="+e+";domain=baidu.com;path=/;expires="+o.toGMTString(),"function"==typeof t?t():"string"==typeof t?location.replace(t):location.reload()}function o(){b.right=b._right=b.parentNode.offsetWidth-b.offsetWidth-b.offsetLeft,b.top=b._top=b.offsetTop}function n(){GM_setValue("ge_users",JSON.stringify(S))}function i(){GM_setValue("ge_users_loc",JSON.stringify({right:b.right,top:b.top}))}function a(e,o,i){e.preventDefault(),i=e.target,i.tagName=="A"?(i=i.parentNode,o=i.parentNode,i==o.firstChild?t():i==o.lastChild?GM_openInTab("https://passport.baidu.com/v2/?login&tpl=mn&u="+encodeURIComponent("http://www.baidu.com/")):(i=i.firstChild,t(S[i.innerText||i.textContent],/^\/i\//.test(location.pathname)&&"/"))):i.tagName=="SPAN"&&(o=i.previousSibling,delete S[o.innerText||o.textContent],setTimeout(n,0),o=o.parentNode,o.parentNode.removeChild(o))}function s(e){e&&(b.right=e&&!isNaN(e.right)?e.right:100,b.top=e&&!isNaN(e.top)?e.top:100),b.style.right=b.right+"px",b.style.top=b.top+"px"}function r(e){e.preventDefault(),e.stopPropagation();var t={right:b._right+b.x-e.pageX,top:b._top+e.pageY-b.y};s(t)}function l(){w.innerHTML=b.pin?"●":"○",w.setAttribute("title",b.pin?"固定在页面上":"固定在屏幕上"),b.style.position=b.pin?"absolute":""}function p(){o(),b.pin?b.top+=window.pageYOffset:b.top-=window.pageYOffset,l(),s(),i()}function u(e){GM_addStyle("#ge_u{display:block;padding:10px;text-align:left;}#ge_u .ge_h{display:none;}#ge_u,.ge_p{z-index:10006;font:normal normal 400 12px/18px 宋体;position:fixed;}#ge_u>span{background:white;color:blue;border-radius:3px;border:1px solid #c0c0c0;padding:2px;cursor:pointer;}#ge_u>div{position:relative;margin-top:3px;}#ge_u>div>*{position:absolute;}.ge_u,.ge_p{background:white;border:1px solid silver;box-shadow:5px 5px 7px #333;}.ge_o{padding:20px;border-radius:5px;}.ge_o fieldset{border:1px solid silver;border-radius:5px;padding:5px;}.ge_o textarea{min-height:100px;}.ge_u{width:120px;max-height:400px;overflow-x:hidden;overflow-y:auto;}.ge_u>li{position:relative;display:block;padding:2px 20px 4px 6px;}.ge_u>li:hover{background:lightgray;}.ge_u a{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}.ge_u span{position:absolute;top:0;right:0;color:white;background:#77f;border-radius:3px;margin:2px;cursor:pointer;padding:2px;}"),b=document.createElement("div"),b.id="ge_u",b.innerHTML='<span>马甲<span></span></span><div><ul class="ge_u ge_h"></ul></div>',b.style.display=GM_getValue("float")||"",v=b.querySelector("ul"),v.onclick=a,w=b.firstChild.lastChild,b.pin=!!GM_getValue("ge_pin"),l(),w.onclick=function(){GM_setValue("ge_pin",b.pin=!b.pin),p()},b.onmouseover=function(e){this.contains(e.relatedTarget)||(v.classList.remove("ge_h"),v.style.pixelLeft=b.offsetLeft+b.firstChild.offsetLeft+v.offsetWidth<=document.body.offsetWidth?0:document.body.offsetWidth-b.offsetLeft-b.firstChild.offsetLeft-v.offsetWidth)},b.onmouseout=function(e){this.contains(e.relatedTarget)||v.classList.add("ge_h")};try{e=JSON.parse(GM_getValue("ge_users_loc"))}catch(t){e={}}document.body.appendChild(b),s(e),b.moving=!1,b.firstChild.onmousedown=function(e){e.preventDefault(),e.stopPropagation(),e.target!=b.firstChild||b.moving||(b.moving=!0,o(),b.x=e.pageX,b.y=e.pageY,document.addEventListener("mousemove",r,!1))},b.onmouseup=function(e){b.moving&&(b.moving=!1,e.preventDefault(),e.stopPropagation(),document.removeEventListener("mousemove",r,!1),i())},L=document.createElement("div"),document.body.appendChild(L),c()}function c(){d=["<li><a href=#>未登录状态</a></li>"];for(var e in S)e?d.push("<li><a href=#>"+e.replace(/&/g,"&amp;").replace(/</g,"&lt;")+"</a><span>删</span></li>"):delete S[e];d.push("<li><a href=#>添加马甲</a></li>"),v.innerHTML=d.join("")}function f(e){!L.contains(e.target)&&L.obj&&(v.style.display="",document.removeEventListener("mousedown",f,!1),L.obj.dispose&&L.obj.dispose(),L.innerHTML="",L.style.display="none",L.obj=null)}function g(e,t){L.obj&&L.obj.dispose&&L.obj.dispose(),v.style.display="none",L.className="ge_p",L.innerHTML=e,L.obj=t,t.init&&t.init(),L.style.display="block",document.addEventListener("mousedown",f,!1),L.style.top=(innerHeight-L.offsetHeight)/2+"px",L.style.left=(innerWidth-L.offsetWidth)/2+"px"}function h(e,t){(e=unsafeWindow.PageData)&&e.user&&e.user.is_login&&e.user.name?e=e.user.name:(e=unsafeWindow.s_session)&&(e=e.username),e&&(t=document.cookie.match(/BDUSS=(.*?)(;|$)/),t&&(S[e]=t[1],n()))}function m(){g(v.innerHTML,{init:function(){L.classList.add("ge_u"),L.onclick=a},dispose:function(){L.onclick=null,c()}})}function _(){b.style.display=b.style.display==""?"none":"",GM_setValue("float",b.style.display)}function y(){g('<h3>设置 - 百度马甲切换脚本</h3><label><input type=checkbox id=gu_showfloat>显示悬浮图标</label><br><fieldset><legend>马甲数据 <button id=gu_import>导入</button> <button id=gu_export>导出</button> <a title="复制数据到以下文本框然后点击导入即可导入数据。\n点击导出后复制数据文本即可用于导入。">(?)</a></legend><textarea id=gu_data></textarea></fieldset>',{init:function(){var e=L.querySelector("#gu_showfloat");e.checked=GM_getValue("float")!="none",e.onchange=function(){setTimeout(_,0)};var t=L.querySelector("#gu_data");t.onfocus=function(){t.select()},L.querySelector("#gu_import").onclick=function(){try{e=JSON.parse(t.value)}catch(o){e=null}e&&"object"==typeof e?(S=e,n(),c(),alert("导入成功！")):alert("导入失败！")},L.querySelector("#gu_export").onclick=function(){t.value=JSON.stringify(S)},L.classList.add("ge_o")}})}if(window.top===window&&document.head){var x,b,v,w,M,L=null,S=GM_getValue("ge_users");S=S?JSON.parse(S):{},h(),u(),GM_registerMenuCommand("马甲脚本设置",y),GM_registerMenuCommand("切换马甲（Shift+M）",m),window.addEventListener("keydown",function(e){if(e.target==document.body){if(!e.shiftKey||e.keyCode!=77)return;m(),e.preventDefault()}},!1),e(1,"欢迎使用百度马甲切换脚本！\n功能特点：\n1. “马甲”可以拖动。\n2. 切换固定方式：固定在页面（可随页面滚动）或固定在屏幕。\n3. 扩展菜单中可打开脚本设置面板，支持数据导入导出。\n4. 扩展菜单中呼出或使用快捷键Shift+M呼出马甲切换面板。\n　　　　　　　--Gerald <gera2ld@163.com>")}