// ==UserScript==
// @name	Tieba Quotor
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	http://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.1
// @description	贴吧引用
// @homepage	https://userscripts.org/scripts/show/157071
// @downloadURL	https://userscripts.org/scripts/source/157071.user.js
// @updateURL	https://userscripts.org/scripts/source/157071.meta.js
// @include	http://tieba.baidu.com/*
// @exclude	http://tieba.baidu.com/tb/*
// @require	https://userscripts.org/scripts/source/156795.user.js
// @grant	none
// ==/UserScript==
function initQuotation(){function t(t){t.preventDefault();var a=$(this).parent().hasClass("p_mtail"),n=t.target,i=$(n).parents(".l_post"),r=a?i:$(n).parents(".lzl_single_post"),o=JSON.parse(i.attr("data-field")),l=a?o.author.name:JSON.parse(r.attr("data-field")).user_name;for(i=[],n=r.find(a?"div.d_post_content":"span.lzl_content_main").contents(":not(blockquote)").each(function(t,e){i.push(e)});i.length&&("BR"==i[0].tagName||!/\S/.test(i[0]));)i.shift();for(;i.length;)if(n=i[i.length-1],"BR"!=n.tagName){if(n=n.innerText||n.textContent||n.data,!/^\s*($|——|>>)/.test(n))break;i.pop()}else i.pop();n=[],i.forEach(function(t){n.push(t.outerHTML||t.data||"")}),n=n.join("").replace(/^\s+|\s+$/gi,"").replace(/\s?<a [^>]*>@?(.*?)<\/a>\s?/gi," $1 "),n="引用 @"+l+" ("+o.content.floor+"楼"+(a?"":"之楼中楼")+")<br>"+n+e+"<br>",unsafeWindow.rich_postor._editor.focus(),unsafeWindow.rich_postor._editor.execCommand("inserthtml",n)}var e="<br>————————————————————————————————<br>";$("<a href=#>引用</a>").css({"float":"right","margin-left":"5px"}).appendTo(".p_mtail").click(t),lzl_update.push(function(e){$("<a href=#>引用</a>").css("margin-right","10px").insertBefore(e.find("span.lzl_time")).click(t)})}function initQuotationFormat(){function t(t,e){return'<a href="/f?ct=335675392&sc='+t+"&z="+PageData.thread.id+"#"+t+'" title="精确定位链接">'+e+"</a>"}function e(){for(var n=0,i=0;a.length>n;n++){var r=$(a[n]).children().children();if(r.length){var o=r.parents(".l_post").children("a").attr("name");r[0]&&(r[0].outerHTML="<a href=#"+o+' title="楼层定位链接">'+r[0].innerHTML+"</a>"),r[1]&&(r[1].outerHTML=t(o,r[1].innerHTML))}else a[i++]=a[n]}a.splice(i),a.length&&setTimeout(e,500)}var a=$("ul.p_tail").get();e(),lzl_update.push(function(e){e.find("span.lzl_time").html(function(e,a){return t($(this).parents(".lzl_single_post").children("a").attr("name"),a)})}),utils.addStyle("fieldset .BDE_Image{height:auto !important; width:auto !important; max-height:200px; max-width:560px !important;}"),$("div.d_post_content").each(function(t,e){var a,n,i=-1,r=$(e).contents();for(a=0;r.length>a;a++)n=r[a],i>=0&&"#text"==n.nodeName&&/^\s*—{27,36}\s*$/.test(n.data)?(r.slice(i,i+3).wrapAll("<legend>").parent().add(r.slice(i+4,a).wrapAll("<p class=quote_content>").parent()).wrapAll("<blockquote class=d_quote>").wrapAll("<fieldset>"),$(n).add(r[i+3]).remove(),(n=r[a+1])&&"BR"==n.nodeName&&($(n).remove(),a++),i=-1):"#text"==n.nodeName&&/^引用(\s|&nbsp;?)$/.test(n.data)&&r[a+1]&&"A"==r[a+1].nodeName&&"@"==r[a+1].innerHTML[0]&&r[a+2]&&"#text"==r[a+2].nodeName&&/^\s\(.*?楼\)$/.test(r[a+2].data)&&"BR"==r[a+3].nodeName&&(i=a,a+=3)})}function initLzL(){function t(e){var a=this;a.update=function(){var n=e.find("p.j_pager");return"true"==n.attr("clicked")?a.delay():(lzl_update.forEach(function(t){t(e)}),n.click(function(e){$(this).attr("clicked","true"),e=new t($(this).parents("ul.j_lzl_m_w")),e.delay()}),void 0)},a.delay=function(){setTimeout(a.update,200)}}var e=new t($("ul.j_lzl_m_w"));e.update()}var lzl_update=[];PageData&&PageData.user&&(PageData.thread&&initQuotationFormat(),PageData.user.is_login&&(unsafeWindow.rich_postor&&initQuotation(),unsafeWindow.LzlEditor&&initLzL()));