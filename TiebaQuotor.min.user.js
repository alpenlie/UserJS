// ==UserScript==
// @name	Tieba Quotor
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	http://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.1
// @description	贴吧引用
// @homepage	https://userscripts.org/scripts/show/157071
// @downloadURL	https://userscripts.org/scripts/source/157071.user.js
// @updateURL	https://userscripts.org/scripts/source/157071.meta.js
// @include	http://tieba.baidu.com/*
// @exclude	http://tieba.baidu.com/tb/*
// @require	https://raw.github.com/gera2ld/UserJS/master/lib/TiebaCommon.min.user.js
// ==/UserScript==
function t(){function t(t){t.preventDefault();var a=$(this).parent().hasClass("p_mtail"),n=t.target,r=$(n).parents(".l_post"),i=a?r:$(n).parents(".lzl_single_post"),o=JSON.parse(r.attr("data-field")),s=a?o.author.name:JSON.parse(i.attr("data-field")).user_name;for(r=[],n=i.find(a?"div.d_post_content":"span.lzl_content_main").contents(":not(blockquote)").each(function(t,e){r.push(e)});r.length&&(r[0].tagName=="BR"||!/\S/.test(r[0]));)r.shift();for(;r.length;)if(n=r[r.length-1],n.tagName!="BR"){if(n=n.innerText||n.textContent||n.data,!/^\s*($|——|>>)/.test(n))break;r.pop()}else r.pop();n=[],r.forEach(function(t){n.push(t.outerHTML||t.data||"")}),n=n.join("").replace(/^\s+|\s+$/gi,"").replace(/\s?<a [^>]*>@?(.*?)<\/a>\s?/gi," $1 "),n="引用 @"+s+" ("+o.content.floor+"楼"+(a?"":"之楼中楼")+")<br>"+n+e+"<br>",unsafeWindow.rich_postor._editor.focus(),unsafeWindow.rich_postor._editor.execCommand("inserthtml",n)}var e="<br>————————————————————————————————<br>";$("<a href=#>引用</a>").css({"float":"right","margin-left":"5px"}).appendTo(".p_mtail").click(t),n.push(function(e){$("<a href=#>引用</a>").css("margin-right","10px").insertBefore(e.find("span.lzl_time")).click(t)})}function e(){function t(t,e){return'<a href="/f?ct=335675392&sc='+t+"&z="+PageData.thread.id+"#"+t+'" title="精确定位链接">'+e+"</a>"}function e(){for(var n=0,r=0;n<a.length;n++){var i=$(a[n]).children().children();if(i.length){var o=i.parents(".l_post").children("a").attr("name");i[0]&&(i[0].outerHTML="<a href=#"+o+' title="楼层定位链接">'+i[0].innerHTML+"</a>"),i[1]&&(i[1].outerHTML=t(o,i[1].innerHTML))}else a[r++]=a[n]}a.splice(r),a.length&&setTimeout(e,500)}var a=$("ul.p_tail").get();e(),n.push(function(e){e.find("span.lzl_time").html(function(e,a){return t($(this).parents(".lzl_single_post").children("a").attr("name"),a)})}),utils.addStyle("fieldset .BDE_Image{height:auto !important; width:auto !important; max-height:200px; max-width:560px !important;}"),$("div.d_post_content").each(function(t,e){var a,n,r=-1,i=$(e).contents();for(a=0;a<i.length;a++)n=i[a],r>=0&&n.nodeName=="#text"&&/^\s*—{27,36}\s*$/.test(n.data)?(i.slice(r,r+3).wrapAll("<legend>").parent().add(i.slice(r+4,a).wrapAll("<p class=quote_content>").parent()).wrapAll("<blockquote class=d_quote>").wrapAll("<fieldset>"),$(n).add(i[r+3]).remove(),(n=i[a+1])&&n.nodeName=="BR"&&($(n).remove(),a++),r=-1):n.nodeName=="#text"&&/^引用(\s|&nbsp;?)$/.test(n.data)&&i[a+1]&&i[a+1].nodeName=="A"&&i[a+1].innerHTML[0]=="@"&&i[a+2]&&i[a+2].nodeName=="#text"&&/^\s\(.*?楼\)$/.test(i[a+2].data)&&i[a+3].nodeName=="BR"&&(r=a,a+=3)})}function a(){function t(e){var a=this;a.update=function(){var r=e.find("p.j_pager");return r.attr("clicked")=="true"?a.delay():(n.forEach(function(t){t(e)}),r.click(function(e){$(this).attr("clicked","true"),e=new t($(this).parents("ul.j_lzl_m_w")),e.delay()}),void 0)},a.delay=function(){setTimeout(a.update,200)}}var e=new t($("ul.j_lzl_m_w"));e.update()}var n=[];PageData&&PageData.user&&(PageData.thread&&e(),PageData.user.is_login&&(unsafeWindow.rich_postor&&t(),unsafeWindow.LzlEditor&&a()));
