// ==UserScript==
// @name	Tieba Sign
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	https://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.2
// @description	贴吧签到
// @homepage	https://userscripts.org/scripts/show/154159
// @downloadURL	https://userscripts.org/scripts/source/154159.user.js
// @updateURL	https://userscripts.org/scripts/source/154159.meta.js
// @include	http://tieba.baidu.com/*
// @exclude	http://tieba.baidu.com/tb/*
// @grant GM_getValue
// @grant GM_setValue
// @grant	GM_xmlhttpRequest
// ==/UserScript==
function e(e,n,a){function t(){GM_setValue(a,e.prop(n))}return e.prop(n,GM_getValue(a)),e.bind("change",function(){setTimeout(t,0)}),e}function n(e,n){if(GM_getValue(e)==void 0){var a=localStorage.getItem("ge_sign_"+e);if(a){localStorage.removeItem("ge_sign_"+e);try{a=JSON.parse(a)}catch(t){a=null}}a||(a=n),GM_setValue(e,a)}}function a(e,n){function a(){i.err=2,i.msg="网络错误",n(i)}var t="http://wapp.baidu.com",i={err:-1};GM_xmlhttpRequest({method:"GET",url:t+"/f?kw="+e,onload:function(e){var r,s;if(s=e.responseText.match(/<(\w+) style="text-align:right;">(.*?)<\/\1>/))if(s=s[2]){if(r=s.match(/<a href="(.*?)">签到<\/a>/))return GM_xmlhttpRequest({method:"GET",url:t+r[1].replace(/&amp;/g,"&"),onload:function(e){e=e.responseText.match(/<span class="light">(.*?)<div/),e&&(i.msg=e[1].replace(/<[^>]*>/g,""),/^签到成功/.test(i.msg)&&(i.err=0)),n(i)},onerror:a});(r=s.match(/<span >已签到<\/span>/))&&(i.err=0,i.msg="已签到")}else i.err=1;n(i)},onerror:a})}function t(){if(GM_getValue("wap")&&!r("#balv_dolike").length)a(s.forum.name,function(e){e.err||(o.removeClass("j_cansign signstar_btn").addClass("signstar_signed").html('<span class="sign_keep_span">WAP签到成功</span>'),r("#signstar_wrapper").addClass("signstar_wrapper_signed"))});else{var e=unsafeWindow.Sign_rank;r.tb.post(e.sign_url,{kw:s.forum.name,tbs:s.tbs,ie:"utf-8"},function(n){if(n&&n.no==0){r(".j_today_signnum").html(n.data.finfo.current_rank_info.sign_count);var a=(s.forum.version>=2?2:1,new Date(n.data.uinfo.sign_time));e.sign_year=e.orign_year=a.getFullYear(),e.sign_month=e.orign_month=a.getMonth()+1,e.sign_load_month(1)}},"json")}}function i(){function n(){function e(e){e.err?(e.err==1?(e.color="blue",e.msg="未开通签到",e.text="未开通"):(e.color="red",e.msg=e.msg||"未知错误",e.text="出错"),h=r('<span style="color:'+e.color+'" title="'+e.msg+'">'+e.text+"<span>")):h=r('<div class="forum_sign" title="'+e.msg+'" style="display: block;"> </div>'),h.insertBefore(n.children(".always_go_manage"))}var n=i.first(),s=n.children(".j_ba_link");i=i.not(n),GM_getValue("wap")&&s.attr("forum-like")=="1"?a(s.attr("forum"),function(n){e(n),t()}):r.get(s.attr("href"),function(n){var a=n.match(/"is_sign_in":(\d+),"user_sign_rank":(\d+),/);if(a&&a[1]=="1")e({err:0,msg:"签到成功，排名"+a[2]});else{if(a=n.match(/PageData\.tbs = "(.*?)";/))return r.post("/sign/add",{ie:"utf-8",kw:s.html(),tbs:a[1]},function(n){n.no?e({err:-1,msg:n.no+": "+n.error}):e({err:0,msg:"签到成功，排名"+n.data.uinfo.user_sign_rank}),t()},"json");e({err:-1})}t()}).error(function(n,a,i){e({err:-1,msg:i}),t()})}function t(e){if(e){if(u.is(":visible"))return;u.show(),i=r("#always_go_list>ul>li:has(a.j_ba_link):not(:has(.forum_sign))"),i.children("span").remove()}i.length?setTimeout(n,e?0:2e3):u.hide()}var i=r("#jsaddlike");if(i.length){i.html(function(e,n){return n.replace(/(自定义添加<\/a>)/,'$1<span class=add_like_sep> </span><a href=# class="j_tab add_like_tab" id=import_like>导入“我喜欢的贴吧”</a>')});var l=unsafeWindow.oftenForum.bindEventToFloatlayer;unsafeWindow.oftenForum.bindEventToFloatlayer=function(){var e=l.apply(this,arguments);return r("#import_like").click(function(e){function n(e){for(var i,o=new RegExp('<a href="/f\\?kw=[^>]*?>(.*?)</a>',"g");i=o.exec(e);)r.post("/i/submit/add_user_favoforum",{ie:"utf-8",kw:i[1],tbs:s.tbs},function(e){e.is_done&&r("#imported").html(++t)},"json");a&&(a=!1,e.match(/\/f\/like\/mylike\?&pn=\d+">\d/g).forEach(function(e){r.get(e.slice(0,-3),n)}))}e.preventDefault(),r(this).replaceWith('<span class="j_tab add_like_tab" style="color:red">已添加 <span id=imported>0</span> 个贴吧</span> <a href=# onclick="location.reload();">刷新</a>');var a=!0,t=0;r.get("/f/like/mylike",n)}),e};var u=r('<span id=signing style="color:red;margin:0 20px;display:none">正在签到...</span>').appendTo("span.head_title"),d=r("<li>").addClass("nav_item").appendTo("ul.nav_bar").hover(function(){o.toggle()});r('<a href=# title="自动签到“我爱逛的贴吧”。如有需要，可在通过下面的“添加”导入所有“我喜欢的贴吧”~">自动签到</a>').appendTo(d).click(t),r("<style>.nav_bar{background-color:#d0dbed;}</style>").appendTo(d),o=r('<div class=nav_bar style="padding:10px;display:none;z-index:10;position:absolute;max-width:80px;background-image:none;">').appendTo(d),e(r("<input type=checkbox>").prependTo(r('<label title="自动签到和访问时模拟WAP签到">模拟WAP</label>').appendTo(o)),"checked","wap"),r("<br>").appendTo(o),e(r("<input type=checkbox>").prependTo(r('<label title="访问贴吧时自动签到">访问时签到</label>').appendTo(o)),"checked","sign")}}var r=unsafeWindow.$,s=unsafeWindow.PageData,o;s&&s.user&&s.user.is_login&&(n("sign",!0),n("wap",!0),GM_getValue("sign")&&!s.user.is_black&&(o=r("#sign_mod .j_cansign")).length&&t(),unsafeWindow.oftenForum&&i());