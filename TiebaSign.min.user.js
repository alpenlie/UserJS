// ==UserScript==
// @name	Tieba Sign
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	http://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.2.3.1
// @description	贴吧签到
// @homepage	http://userscripts.org/scripts/show/154159
// @downloadURL	https://userscripts.org/scripts/source/154159.user.js
// @updateURL	https://userscripts.org/scripts/source/154159.meta.js
// @include	http://tieba.baidu.com/*
// @exclude	http://tieba.baidu.com/tb/*
// @grant GM_getValue
// @grant GM_setValue
// ==/UserScript==
function e(e,n,a){function t(){GM_setValue(a,e.prop(n))}return e.prop(n,GM_getValue(a)),e.bind("change",function(){setTimeout(t,0)}),e}function n(e,n){if(GM_getValue(e)==void 0){var a=localStorage.getItem("ge_sign_"+e);if(a){localStorage.removeItem("ge_sign_"+e);try{a=JSON.parse(a)}catch(t){a=null}}a||(a=n),GM_setValue(e,a)}}function a(e,n){function a(e,a){var i=new XMLHttpRequest;i.open("GET",e,!0),i.onerror=function(){t.err=2,t.msg="网络错误",n(t)},i.onload=a,i.send()}var t={err:-1};a("/mo/?kw="+e,function(){var e,i;if(i=this.responseText.match(/<(\w+) style="text-align:right;">(.*?)<\/\1>/))if(i=i[2]){if(e=i.match(/<a href="(.*?)">签到<\/a>/))return a(e[1].replace(/&amp;/g,"&"),function(){(e=this.responseText.match(/<span class="light">(.*?)<div/))&&(t.msg=e[1].replace(/<[^>]*>/g,""),/^签到成功/.test(t.msg)&&(t.err=0)),n(t)});i.match(/<span >已签到<\/span>/)&&(t.err=0,t.msg="已签到")}else t.err=1;n(t)})}function t(e){e.length&&(GM_getValue("wap")&&!s("#balv_dolike").length?a(r.forum.name,function(n){n.err||(e.removeClass("j_cansign signstar_btn").addClass("signstar_signed").html('<span class="sign_keep_span">WAP成功</span>'),s("#signstar_wrapper").addClass("signstar_wrapper_signed sign_box_bright_signed"))}):s(".j_cansign").click())}function i(){function n(){function e(e){e.err?(e.err==1?(e.color="blue",e.msg="未开通签到",e.text="未开通"):(e.color="red",e.msg=e.msg||"未知错误",e.text="出错"),h=s('<span style="color:'+e.color+'" title="'+e.msg+'">'+e.text+"<span>")):h=s('<div class="forum_sign" title="'+e.msg+'" style="display: block;"> </div>'),h.insertBefore(n.children(".always_go_manage"))}var n=i.first(),r=n.children(".j_ba_link");i=i.not(n),GM_getValue("wap")&&r.attr("forum-like")=="1"?a(r.attr("forum"),function(n){e(n),t()}):s.get(r.attr("href"),function(n){var a=n.match(/"is_sign_in":(\d+),"user_sign_rank":(\d+),/);if(a&&a[1]=="1")e({err:0,msg:"签到成功，排名"+a[2]});else{if(a=n.match(/PageData\.tbs = "(.*?)";/))return s.post("/sign/add",{ie:"utf-8",kw:r.html(),tbs:a[1]},function(n){n.no?e({err:-1,msg:n.no+": "+n.error}):e({err:0,msg:"签到成功，排名"+n.data.uinfo.user_sign_rank}),t()},"json");e({err:-1})}t()}).error(function(n,a,i){e({err:-1,msg:i}),t()})}function t(e){if(e){if(l.is(":visible"))return;l.show(),i=s("#always_go_list>ul>li:has(a.j_ba_link):not(:has(.forum_sign))"),i.children("span").remove()}i.length?setTimeout(n,e?0:1e3):l.hide()}var i=s("#jsaddlike");if(i.length){i.html(function(e,n){return n.replace(/(自定义添加<\/a>)/,'$1<span class=add_like_sep> </span><a href=# class="j_tab add_like_tab" id=import_like>导入“我喜欢的贴吧”</a>')});var o=unsafeWindow.oftenForum.bindEventToFloatlayer;unsafeWindow.oftenForum.bindEventToFloatlayer=function(){var e=o.apply(this,arguments);return s("#import_like").click(function(e){function n(e){for(var i,o=new RegExp('<a href="/f\\?kw=[^>]*?>(.*?)</a>',"g");i=o.exec(e);)s.post("/i/submit/add_user_favoforum",{ie:"utf-8",kw:i[1],tbs:r.tbs},function(e){e.is_done&&s("#imported").html(++t)},"json");a&&(a=!1,e.match(/\/f\/like\/mylike\?&pn=\d+">\d/g).forEach(function(e){s.get(e.slice(0,-3),n)}))}e.preventDefault(),s(this).replaceWith('<span class="j_tab add_like_tab" style="color:red">已添加 <span id=imported>0</span> 个贴吧</span> <a href=# onclick="location.reload();">刷新</a>');var a=!0,t=0;s.get("/f/like/mylike",n)}),e};var l=s('<span id=signing style="color:red;margin:0 20px;display:none">正在签到...</span>').appendTo("span.head_title"),c=s("<li>").addClass("nav_item").appendTo("ul.nav_bar").hover(function(){p.toggle()}),p=s('<div class=nav_bar style="padding:10px;display:none;z-index:10;position:absolute;max-width:80px;background-image:none;">');s('<a href=# title="自动签到“我爱逛的贴吧”。如有需要，可在通过下面的“添加”导入所有“我喜欢的贴吧”~">自动签到</a>').appendTo(c).click(t),s("<style>.nav_bar{background-color:#d0dbed;}</style>").appendTo(c),p.appendTo(c),e(s("<input type=checkbox>").prependTo(s('<label title="自动签到和访问时模拟WAP签到">模拟WAP</label>').appendTo(p)),"checked","wap"),s("<br>").appendTo(p),e(s("<input type=checkbox>").prependTo(s('<label title="访问贴吧时自动签到">访问时签到</label>').appendTo(p)),"checked","sign")}}var s=unsafeWindow.$,r=unsafeWindow.PageData;r&&r.user&&r.user.is_login&&(n("sign",!0),n("wap",!0),GM_getValue("sign")&&!r.user.is_black&&t(s("#sign_mod .j_cansign")),unsafeWindow.oftenForum&&i());