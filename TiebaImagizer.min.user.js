// ==UserScript==
// @name	Tieba Imagizer
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	http://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.0.2
// @description	贴吧图化 - Gerald倾情打造
// @homepage	https://userscripts.org/scripts/show/156579
// @downloadURL	https://userscripts.org/scripts/source/156579.user.js
// @updateURL	https://userscripts.org/scripts/source/156579.meta.js
// @include	http://tieba.baidu.com/*
// @exclude	http://tieba.baidu.com/tb/*
// @require	https://raw.github.com/gera2ld/UserJS/master/lib/TiebaCommon.min.user.js
// ==/UserScript==
function o(e){var o="http://static.tieba.baidu.com/tb/static-frs/component/sign_shai/flash_image_loader.js";unsafeWindow.FlashImageLoader?e():$.getScript(o,e)}function t(){if(!utils.colorInput){if(navigator.userAgent.indexOf("Firefox")<0)return utils.colorInput=function(e,o,t,a){return utils.bindProp($("<input type=color id="+e+" class=ge_rsep>"),"value",o,t,a,["change","keyup"])};utils.addStyle("#colors{display:none;position:absolute;background:white;border:2px ridge;padding:10px;cursor:default;}#colors .colors{width:261px;cursor:pointer;margin:2px;border-collapse:separate;border-spacing:1px;background:black;}#colors .colors td{display:table-cell !important;width:12px;height:12px;border:none;emptycells:show;}.colorbox{width:12px;height:12px;border:1px solid;display:inline-block;position:relative;top:3px;}");var e,o,t,a=$("<div id=colors>");e=function(e){var t=$(e.target).attr("data");t&&(e.type=="mouseover"?(o&&o.css("outline","none"),o=$(e.target).css("outline","1px outset yellow"),$("#ge_vcolor").val(t)):a.owner.set(t))},t=$("<table class=colors>").appendTo(a).mouseover(e).click(e);for(var i=["00","33","66","99","cc","ff"],r=["#ffffff","#ff0000","#00ff00","#0000ff","#ffff00","#00ffff","#ff00ff"],n=0;12>n;n++){e=$("<tr>").appendTo(t),o=6>n?"#"+i[n]+i[n]+i[n]:r[n-6],$("<td>").appendTo(e).css({background:o}).attr("data",o),n||$('<td rowspan=12 style="background:white;">').appendTo(e);for(var s=0;18>s;s++)o="#"+i[Math.floor(n/6)*3+Math.floor(s/6)]+i[s%6]+i[n%6],$("<td>").appendTo(e).css({background:o}).attr("data",o)}t=$("<form>").appendTo(a),$('<span id=ge_scolor class="ge_rsep colorbox">').appendTo(t),e=function(){$("#ge_scolor").css("background",this.value)},$('<input type=text id=ge_vcolor style="width:60px" class=ge_rsep>').appendTo(t).change(e).keyup(e),e=function(e){e.preventDefault(),a.owner.set($("#ge_scolor").css("background-color"))},$("<span class=ge_sbtn>OK</span>").appendTo(t).click(e),t.submit(e),o=null,utils.colorInput=function(e,o,t,i){var r=$("<span id="+e+" class=colorbox>"),n=r[0],s=utils.getObj(o,t);return n.val=function(){return $(this).attr("data")},r.css({border:"1px outset white",cursor:"pointer",background:s}).attr("data",s).click(function(e){e.preventDefault(),e.target==n&&(a.owner!=n?(a.owner=n,a.appendTo(r).css({top:"auto",bottom:"auto"}).show(),a.offset().top+a.height()>pageYOffset+innerHeight?a.css("bottom","14px"):a.css("top","14px"),$("#ge_scolor").css("background",e=r.attr("data")),$("#ge_vcolor").val(e)):(a.owner=null,a.hide()))}),n.set=function(e){e=e.replace(/rgb\((\d+),\s?(\d+),\s?(\d+)\)/i,function(e,o,t,a){e=[o,t,a];for(o in e)e[o]=parseInt(e[o]).toString(16),e[o].length<2&&(e[o]="0"+e[o]);return"#"+e.join("")}),r.attr("data",e).css("background",e),utils.setObj(o,e),a.owner=null,a.hide(),i()},n}}}function a(){var e={},o=[];return $("#w2iitalic").prop("checked")&&o.push("italic"),$("#w2ibold").prop("checked")&&o.push("bold"),o.push($("#w2isize").val()+"px"),b.val()&&o.push(b.val()),e.font=o.join(" "),e.color=g.val(),e.background=$("#w2iabgclr").prop("checked")?h.val():"transparent",e}function r(){o(function(){utils.uploadImage=function(e,o){function t(e,a){var i=JSON.parse(a);if(i.error_code)alert("图片上传错误！");else{var r="http://imgsrc.baidu.com/forum/pic/item/"+i.info.pic_id_encode+".png";$(o).replaceWith('<image pic_type="5" class="BDE_Image" src="'+r+'">')}unsafeWindow.FlashImageLoader.unbind("uploadComplete",t)}$.get("/dc/common/imgtbs",function(o){unsafeWindow.FlashImageLoader.bind("uploadComplete",t),unsafeWindow.FlashImageLoader.uploadBase64("http://upload.tieba.baidu.com/upload/pic",e.replace(/^data:.*?;base64,/,""),{tbs:o.data.tbs})},"json")},u.removeClass("ge_disabled").text("开始图化").unbind("click").click(n),$.get(l)})}function n(){c=unsafeWindow.rich_postor._editor.editArea.innerHTML,w.removeClass("ge_disabled");var o,t=parseInt($("#w2isize").val()),r=unsafeWindow.rich_postor._editor.savedRange,n=$('<img title="双击撤销">').attr("src",l);if(r&&r.toString()){if(o=utils.innerText(r.extractContents()),!/\S/.test(o))return;r.insertNode(n[0])}else{if(r=unsafeWindow.rich_postor._editor.editArea,o=utils.innerText(r),!/\S/.test(o))return;$(r).html(n)}var s=o.split("\n"),p=0,d=document.createElement("canvas"),u=d.getContext("2d"),f=Math.round(1.5*t);o=a(),u.font=o.font;var b=[];s.forEach(function(e){e=e.replace(/\s+$/,"");do{for(var o=0,t=0;t<e.length&&(o+=u.measureText(e[t]).width,!(o>560));t++)o>p&&(p=o);b.push(e.substr(0,t)),e=e.substr(t)}while(e)}),d.height=f*b.length,d.width=p,$("#w2ishadow").prop("checked")&&(u.shadowColor="gray",u.shadowBlur=u.shadowOffsetY=u.shadowOffsetX=Math.ceil(t/25)),$("#w2iabgclr").prop("checked")&&(u.fillStyle=o.background,u.fillRect(0,0,p,d.height)),u.font=o.font,u.fillStyle=u.strokeStyle=o.color,e=$("#w2istroke").prop("checked")?u.strokeText:u.fillText,i=0,b.forEach(function(o){e.call(u,o,0,t+f*i++)}),utils.uploadImage(d.toDataURL(),n)}function s(e){e=a();var o,t="";for(o in e)e[o]+=" !important";$("#w2ipreview").prop("checked")?p.html("#edit_parent .tb-editor-editarea{font:"+e.font+";color:"+e.color+";background:"+e.background+"}"):p.html("");for(o in e)t+=o+":"+e[o]+";";b.css("cssText",t)}var l="http://imgsrc.baidu.com/forum/pic/item/93ac22d7912397dd818c85fc5982b2b7d2a287e1.jpg";if(PageData&&PageData.user&&PageData.user.is_login&&unsafeWindow.rich_postor){var p=utils.addStyle(),c=null,d=utils.addPopup($("#edit_parent"),utils.addSButton("图化")),u=$('<div class="ge_sbtn ge_disabled" style="margin:0 0 2px;">图化组件初始化失败，点击重试</div>').appendTo(d).click(r);r();var f=utils.list("w2ifaces","w2ifaceid",null,["微软雅黑"]).load();$("<label for=w2iface>字体：</label>").appendTo(d);var b=$('<select id=w2iface style="font-size:200%">').appendTo(d).change(function(){f.load(b.prop("selectedIndex")),s()});f.list.forEach(function(e){$("<option>"+e+"</option>").appendTo(b)}),b.prop("selectedIndex",f.last),$("<span class=ge_sbtn>+</span>").appendTo(d).click(function(e){e=prompt("请输入字体名称："),e&&(f.load(f.push(e)),$("<option>").text(e).appendTo(b),b.val(e),s())}),$("<span class=ge_sbtn>-</span>").appendTo(d).click(function(e){e=b.prop("selectedIndex"),b.children(":eq("+e+")").remove(),f.pop(e),f.load(b.prop("selectedIndex")),s()}),t();var g,h;utils.bindProp($("<input type=checkbox id=w2ipreview>").appendTo(d),"checked","w2ipreview",!1,s),$("<label for=w2ipreview>预览</label><br><label for=w2icolor>颜色：</label>").appendTo(d),$(g=utils.colorInput("w2icolor","w2icolor","#2222ff",s)).appendTo(d).addClass("ge_rsep"),$("<label for=w2isize>大小：</label>").appendTo(d),utils.bindProp($('<input type=number id=w2isize min=9 class=ge_rsep style="height:18px;width:40px;">').appendTo(d),"value","w2isize",22,s),utils.bindProp($("<input type=checkbox id=w2iabgclr>").appendTo(d),"checked","w2iabgclr",!1,s),$("<label for=w2iabgclr>背景色：</label>").appendTo(d),$(h=utils.colorInput("w2ibgclr","w2ibgclr","#efe4b0",s)).appendTo(d),$("<br>").appendTo(d),utils.bindProp($("<input type=checkbox id=w2ibold>").appendTo(d),"checked","w2ibold",!1,s),$("<label for=w2ibold class=ge_rsep>加粗</label>").appendTo(d),utils.bindProp($("<input type=checkbox id=w2iitalic>").appendTo(d),"checked","w2iitalic",!1,s),$("<label for=w2iitalic class=ge_rsep>倾斜</label>").appendTo(d),utils.bindProp($("<input type=checkbox id=w2ishadow>").appendTo(d),"checked","w2ishadow",!1,s),$("<label for=w2ishadow class=ge_rsep>阴影</label>").appendTo(d),utils.bindProp($("<input type=checkbox id=w2istroke>").appendTo(d),"checked","w2istroke",!1,s),$("<label for=w2istroke class=ge_rsep>镂空</label>").appendTo(d);var w=$('<span class="ge_sbtn ge_disabled" title="回到最后一次图化前的状态">撤销图化</span>').appendTo(d).click(function(){c&&(unsafeWindow.rich_postor._editor.editArea.innerHTML=c,c=null,w.addClass("ge_disabled"))});b.prop("selectedIndex",f.last),s()}
