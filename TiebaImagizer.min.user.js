// ==UserScript==
// @name	Tieba Imagizer
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	http://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.1
// @description	贴吧图化 - Gerald倾情打造
// @homepage	http://userscripts.org/scripts/show/156579
// @downloadURL	https://userscripts.org/scripts/source/156579.user.js
// @updateURL	https://userscripts.org/scripts/source/156579.meta.js
// @include	http://tieba.baidu.com/*
// @exclude	http://tieba.baidu.com/tb/*
// @require	https://raw.github.com/gera2ld/UserJS/master/lib/TiebaCommon.min.user.js
// ==/UserScript==
function o(e){var o="http://static.tieba.baidu.com/tb/static-frs/component/sign_shai/flash_image_loader.js";unsafeWindow.FlashImageLoader?e():$.getScript(o,e)}function t(){if(!utils.colorInput){if(!/(Firefox|OPR)\//.test(navigator.userAgent))return utils.colorInput=function(e,o,t,a){return utils.bindProp($("<input type=color id="+e+" class=ge_rsep>"),"value",o,t,a,["change","keyup"])};utils.addStyle("#colors{display:none;position:absolute;background:white;border:2px ridge;padding:10px;cursor:default;}#colors .colors{width:261px;cursor:pointer;margin:2px;border-collapse:separate;border-spacing:1px;background:black;}#colors .colors td{display:table-cell !important;width:12px;height:12px;border:none;emptycells:show;}.colorbox{width:12px;height:12px;border:1px solid;display:inline-block;position:relative;top:3px;}");var e,o,t,a=$("<div id=colors>").click(function(e){e.stopPropagation()});e=function(e){var t=$(e.target).attr("data");t&&("mouseover"==e.type?(o&&o.css("outline","none"),o=$(e.target).css("outline","1px outset yellow"),$("#ge_vcolor").val(t)):a.owner.setColor(t))},t=$("<table class=colors>").appendTo(a).mouseover(e).click(e);for(var i=["00","33","66","99","cc","ff"],n=["#ffffff","#ff0000","#00ff00","#0000ff","#ffff00","#00ffff","#ff00ff"],r=0;12>r;r++){e=$("<tr>").appendTo(t),o=6>r?"#"+i[r]+i[r]+i[r]:n[r-6],$("<td>").appendTo(e).css({background:o}).attr("data",o),r||$('<td rowspan=12 style="background:white;">').appendTo(e);for(var l=0;18>l;l++)o="#"+i[3*Math.floor(r/6)+Math.floor(l/6)]+i[l%6]+i[r%6],$("<td>").appendTo(e).css({background:o}).attr("data",o)}t=$("<form>").appendTo(a),$('<span id=ge_scolor class="ge_rsep colorbox">').appendTo(t),e=function(){$("#ge_scolor").css("background",this.value)},$('<input type=text id=ge_vcolor style="width:60px" class=ge_rsep>').appendTo(t).change(e).keyup(e),e=function(e){e.preventDefault(),a.owner.setColor($("#ge_scolor").css("background-color"))},$("<span class=ge_sbtn>OK</span>").appendTo(t).click(e),t.submit(e),o=null,utils.colorInput=function(e,o,t,i){var n=$("<span id="+e+" class=colorbox>"),r=utils.getObj(o,t);return n.css({border:"1px outset white",cursor:"pointer",background:r}).attr("data",r).click(function(e){a.owner!=n?(a.owner=n,a.appendTo(n).css({top:"auto",bottom:"auto"}).show(),a.offset().top+a.height()>pageYOffset+innerHeight?a.css("bottom","14px"):a.css("top","14px"),$("#ge_scolor").css("background",e=n.attr("data")),$("#ge_vcolor").val(e)):(a.owner=null,a.hide())}),n.setColor=function(e){e=e.replace(/rgb\((\d+),\s?(\d+),\s?(\d+)\)/i,function(e,o,t,a){e=[o,t,a];for(o in e)e[o]=parseInt(e[o]).toString(16),e[o].length<2&&(e[o]="0"+e[o]);return"#"+e.join("")}),n.attr("data",e).css("background",e),utils.setObj(o,e),a.owner=null,a.hide(),i()},n[0].val=function(){return n.attr("data")},n[0]}}}function a(){var e={},o=[];return $("#w2iitalic").prop("checked")&&o.push("italic"),$("#w2ibold").prop("checked")&&o.push("bold"),o.push($("#w2isize").val()+"px"),h.val()&&o.push(h.val()),e.font=o.join(" "),e.color=w.val(),e.background=$("#w2iabgclr").prop("checked")?m.val():"transparent",e}function n(){u&&(unsafeWindow.rich_postor._editor.editArea.innerHTML=u,u=null,k.addClass("ge_disabled"))}function r(){o(function(){utils.uploadImage=function(e,o){function t(){alert("图片上传发生错误！"),n(),r()}function a(e,a){var i=JSON.parse(a);if(i.error_code)t();else{var n="http://imgsrc.baidu.com/forum/pic/item/"+i.info.pic_id_encode+".jpg";$(o).replaceWith('<image pic_type="5" class="BDE_Image" src="'+n+'">'),r()}}function i(){unsafeWindow.FlashImageLoader.bind("uploadComplete",a),unsafeWindow.FlashImageLoader.bind("uploadError",t)}function r(){unsafeWindow.FlashImageLoader.unbind("uploadComplete",a),unsafeWindow.FlashImageLoader.unbind("uploadError",t)}$.get("/dc/common/imgtbs",function(o){i(),unsafeWindow.FlashImageLoader.uploadBase64("http://upload.tieba.baidu.com/upload/pic",e.replace(/^data:.*?;base64,/,""),{tbs:o.data.tbs})},"json")},b.removeClass("ge_disabled").text("开始图化").unbind("click").click(s),$.get(c)})}function l(e){return $("<div>").append(e.childNodes).html(function(e,o){return o.replace(/<br>(<\/p>)?|<\/p>/gi,"\n")}).text().replace(/\s+$/,"")}function s(){u=unsafeWindow.rich_postor._editor.editArea.innerHTML,k.removeClass("ge_disabled");var o,t=parseInt($("#w2isize").val()),n=unsafeWindow.rich_postor._editor.savedRange,r=$('<img title="双击撤销">').attr("src",c);if(n&&n.toString()){if(o=l(n.extractContents()),!/\S/.test(o))return;n.insertNode(r[0])}else{if(n=unsafeWindow.rich_postor._editor.editArea,o=l(n),!/\S/.test(o))return;$(n).html(r)}var s=o.split("\n"),p=0,d=document.createElement("canvas"),f=d.getContext("2d"),b=Math.round(1.5*t),g=[];o=a(),f.font=o.font,s.forEach(function(e){e=e.replace(/\s+$/,"");do{for(var o=0,t=0;t<e.length&&(o+=f.measureText(e[t]).width,!(o>560));t++)o>p&&(p=o);g.push(e.substr(0,t)),e=e.substr(t)}while(e)}),d.height=b*g.length,d.width=p,$("#w2ishadow").prop("checked")&&(f.shadowColor="gray",f.shadowBlur=f.shadowOffsetY=f.shadowOffsetX=Math.ceil(t/25)),$("#w2iabgclr").prop("checked")&&(f.fillStyle=o.background,f.fillRect(0,0,p,d.height)),f.font=o.font,f.fillStyle=f.strokeStyle=o.color,e=$("#w2istroke").prop("checked")?f.strokeText:f.fillText,i=0,g.forEach(function(o){e.call(f,o,0,t+b*i++)}),utils.uploadImage(d.toDataURL(),r)}function p(e){e=a();var o,t="";for(o in e)e[o]+=" !important";$("#w2ipreview").prop("checked")?d.html("#edit_parent .tb-editor-editarea{font:"+e.font+";color:"+e.color+";background:"+e.background+"}"):d.html("");for(o in e)t+=o+":"+e[o]+";";h.css("cssText",t)}var c="http://imgsrc.baidu.com/forum/pic/item/93ac22d7912397dd818c85fc5982b2b7d2a287e1.jpg";if(PageData&&PageData.user&&PageData.user.is_login&&unsafeWindow.rich_postor){var d=utils.addStyle(),u=null,f=utils.addPopup($("#edit_parent"),utils.addSButton("图化")).panel,b=$('<div class="ge_sbtn ge_disabled" style="margin:0 0 2px;">图化组件初始化失败，点击重试</div>').appendTo(f).click(r);r(),utils.addStyle("#w2iface{max-width:800px;max-height:400px;}");var g=utils.list("w2ifaces","w2ifaceid",null,["微软雅黑"]).load(),h=$("<select id=w2iface>").appendTo($("<label>字体：</label>").appendTo(f)).change(function(){g.load(h.prop("selectedIndex")),p()});g.list.forEach(function(e){$("<option>"+e+"</option>").appendTo(h)}),h.prop("selectedIndex",g.last),$("<span class=ge_sbtn>+</span>").appendTo(f).click(function(e){e=prompt("请输入字体名称："),e&&(g.load(g.push(e)),$("<option>").text(e).appendTo(h),h.val(e),p())}),$("<span class=ge_sbtn>-</span>").appendTo(f).click(function(e){e=h.prop("selectedIndex"),h.children(":eq("+e+")").remove(),g.pop(e),g.load(h.prop("selectedIndex")),p()}),t();var w,m;utils.bindProp($("<input type=checkbox id=w2ipreview>").appendTo(f),"checked","w2ipreview",!1,p),$("<label for=w2ipreview>预览</label><br><label for=w2icolor>颜色：</label>").appendTo(f),$(w=utils.colorInput("w2icolor","w2icolor","#2222ff",p)).appendTo(f).addClass("ge_rsep"),$("<label for=w2isize>大小：</label>").appendTo(f),utils.bindProp($('<input type=number id=w2isize min=9 class=ge_rsep style="height:18px;width:40px;">').appendTo(f),"value","w2isize",22,p),utils.bindProp($("<input type=checkbox id=w2iabgclr>").appendTo(f),"checked","w2iabgclr",!1,p),$("<label for=w2iabgclr>背景色：</label>").appendTo(f),$(m=utils.colorInput("w2ibgclr","w2ibgclr","#efe4b0",p)).appendTo(f),$("<br>").appendTo(f),utils.bindProp($("<input type=checkbox id=w2ibold>").appendTo(f),"checked","w2ibold",!1,p),$("<label for=w2ibold class=ge_rsep>加粗</label>").appendTo(f),utils.bindProp($("<input type=checkbox id=w2iitalic>").appendTo(f),"checked","w2iitalic",!1,p),$("<label for=w2iitalic class=ge_rsep>倾斜</label>").appendTo(f),utils.bindProp($("<input type=checkbox id=w2ishadow>").appendTo(f),"checked","w2ishadow",!1,p),$("<label for=w2ishadow class=ge_rsep>阴影</label>").appendTo(f),utils.bindProp($("<input type=checkbox id=w2istroke>").appendTo(f),"checked","w2istroke",!1,p),$("<label for=w2istroke class=ge_rsep>镂空</label>").appendTo(f);var k=$('<span class="ge_sbtn ge_disabled" title="回到最后一次图化前的状态">撤销图化</span>').appendTo(f).click(n);h.prop("selectedIndex",g.last),p()}