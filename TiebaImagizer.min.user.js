// ==UserScript==
// @name	Tieba Imagizer
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @icon	http://s.gravatar.com/avatar/a0ad718d86d21262ccd6ff271ece08a3?s=80
// @version	1.0.2
// @description	贴吧图化 - Gerald倾情打造
// @homepage	https://userscripts.org/scripts/show/156579
// @downloadURL	https://userscripts.org/scripts/source/156579.user.js
// @updateURL	https://userscripts.org/scripts/source/156579.meta.js
// @include	http://tieba.baidu.com/*
// @exclude	http://tieba.baidu.com/tb/*
// @require	https://userscripts.org/scripts/source/156795.user.js
// @grant	none
// ==/UserScript==
function initImageLoader(e){var o="http://static.tieba.baidu.com/tb/static-frs/component/sign_shai/flash_image_loader.js";unsafeWindow.FlashImageLoader?e():$.getScript(o,e)}function initColorPanel(){if(!utils.colorInput){if(0>navigator.userAgent.indexOf("Firefox"))return utils.colorInput=function(e,o,t,a){return utils.bindProp($("<input type=color id="+e+" class=ge_rsep>"),"value",o,t,a,["change","keyup"])};utils.addStyle("#colors{display:none;position:absolute;background:white;border:2px ridge;padding:10px;cursor:default;}#colors .colors{width:261px;cursor:pointer;margin:2px;border-collapse:separate;border-spacing:1px;background:black;}#colors .colors td{display:table-cell !important;width:12px;height:12px;border:none;emptycells:show;}.colorbox{width:12px;height:12px;border:1px solid;display:inline-block;position:relative;top:3px;}");var e,o,t,a=$("<div id=colors>");e=function(e){var t=$(e.target).attr("data");t&&("mouseover"==e.type?(o&&o.css("outline","none"),o=$(e.target).css("outline","1px outset yellow"),$("#ge_vcolor").val(t)):a.owner.set(t))},t=$("<table class=colors>").appendTo(a).mouseover(e).click(e);for(var i=["00","33","66","99","cc","ff"],n=["#ffffff","#ff0000","#00ff00","#0000ff","#ffff00","#00ffff","#ff00ff"],r=0;12>r;r++){e=$("<tr>").appendTo(t),o=6>r?"#"+i[r]+i[r]+i[r]:n[r-6],$("<td>").appendTo(e).css({background:o}).attr("data",o),r||$('<td rowspan=12 style="background:white;">').appendTo(e);for(var l=0;18>l;l++)o="#"+i[3*Math.floor(r/6)+Math.floor(l/6)]+i[l%6]+i[r%6],$("<td>").appendTo(e).css({background:o}).attr("data",o)}t=$("<form>").appendTo(a),$('<span id=ge_scolor class="ge_rsep colorbox">').appendTo(t),e=function(){$("#ge_scolor").css("background",this.value)},$('<input type=text id=ge_vcolor style="width:60px" class=ge_rsep>').appendTo(t).change(e).keyup(e),e=function(e){e.preventDefault(),a.owner.set($("#ge_scolor").css("background-color"))},$("<span class=ge_sbtn>OK</span>").appendTo(t).click(e),t.submit(e),o=null,utils.colorInput=function(e,o,t,i){var n=$("<span id="+e+" class=colorbox>"),r=n[0],l=utils.getObj(o,t);return r.val=function(){return $(this).attr("data")},n.css({border:"1px outset white",cursor:"pointer",background:l}).attr("data",l).click(function(e){e.preventDefault(),e.target==r&&(a.owner!=r?(a.owner=r,a.appendTo(n).css({top:"auto",bottom:"auto"}).show(),a.offset().top+a.height()>pageYOffset+innerHeight?a.css("bottom","14px"):a.css("top","14px"),$("#ge_scolor").css("background",e=n.attr("data")),$("#ge_vcolor").val(e)):(a.owner=null,a.hide()))}),r.set=function(e){e=e.replace(/rgb\((\d+),\s?(\d+),\s?(\d+)\)/i,function(e,o,t,a){e=[o,t,a];for(o in e)e[o]=parseInt(e[o]).toString(16),2>e[o].length&&(e[o]="0"+e[o]);return"#"+e.join("")}),n.attr("data",e).css("background",e),utils.setObj(o,e),a.owner=null,a.hide(),i()},r}}}var loadingURL="http://imgsrc.baidu.com/forum/pic/item/93ac22d7912397dd818c85fc5982b2b7d2a287e1.jpg";PageData&&PageData.user&&PageData.user.is_login&&unsafeWindow.rich_postor&&function(){function o(){var e={},o=[];return $("#w2iitalic").prop("checked")&&o.push("italic"),$("#w2ibold").prop("checked")&&o.push("bold"),o.push($("#w2isize").val()+"px"),d.val()&&o.push(d.val()),e.font=o.join(" "),e.color=u.val(),e.background=$("#w2iabgclr").prop("checked")?f.val():"transparent",e}function t(){initImageLoader(function(){utils.uploadImage=function(e,o){function t(e,a){var i=JSON.parse(a);if(i.error_code)alert("图片上传错误！");else{var n="http://imgsrc.baidu.com/forum/pic/item/"+i.info.pic_id_encode+".png";$(o).replaceWith('<image pic_type="5" class="BDE_Image" src="'+n+'">')}unsafeWindow.FlashImageLoader.unbind("uploadComplete",t)}$.get("/dc/common/imgtbs",function(o){unsafeWindow.FlashImageLoader.bind("uploadComplete",t),unsafeWindow.FlashImageLoader.uploadBase64("http://upload.tieba.baidu.com/upload/pic",e.replace(/^data:.*?;base64,/,""),{tbs:o.data.tbs})},"json")},p.removeClass("ge_disabled").text("开始图化").unbind("click").click(a),$.get(loadingURL)})}function a(){l=unsafeWindow.rich_postor._editor.editArea.innerHTML,b.removeClass("ge_disabled");var t,a=parseInt($("#w2isize").val()),n=unsafeWindow.rich_postor._editor.savedRange,r=$('<img title="双击撤销">').attr("src",loadingURL);if(n&&n+""){if(t=utils.innerText(n.extractContents()),!/\S/.test(t))return;n.insertNode(r[0])}else{if(n=unsafeWindow.rich_postor._editor.editArea,t=utils.innerText(n),!/\S/.test(t))return;$(n).html(r)}var s=t.split("\n"),p=0,c=document.createElement("canvas"),d=c.getContext("2d"),u=Math.round(1.5*a);t=o(),d.font=t.font;var f=[];s.forEach(function(e){e=e.replace(/\s+$/,"");do{for(var o=0,t=0;e.length>t&&(o+=d.measureText(e[t]).width,!(o>560));t++)o>p&&(p=o);f.push(e.substr(0,t)),e=e.substr(t)}while(e)}),c.height=u*f.length,c.width=p,$("#w2ishadow").prop("checked")&&(d.shadowColor="gray",d.shadowBlur=d.shadowOffsetY=d.shadowOffsetX=Math.ceil(a/25)),$("#w2iabgclr").prop("checked")&&(d.fillStyle=t.background,d.fillRect(0,0,p,c.height)),d.font=t.font,d.fillStyle=d.strokeStyle=t.color,e=$("#w2istroke").prop("checked")?d.strokeText:d.fillText,i=0,f.forEach(function(o){e.call(d,o,0,a+u*i++)}),utils.uploadImage(c.toDataURL(),r)}function n(e){e=o();var t,a="";for(t in e)e[t]+=" !important";$("#w2ipreview").prop("checked")?r.html("#edit_parent .tb-editor-editarea{font:"+e.font+";color:"+e.color+";background:"+e.background+"}"):r.html("");for(t in e)a+=t+":"+e[t]+";";d.css("cssText",a)}var r=utils.addStyle(),l=null,s=utils.addPopup($("#edit_parent"),utils.addSButton("图化")),p=$('<div class="ge_sbtn ge_disabled" style="margin:0 0 2px;">图化组件初始化失败，点击重试</div>').appendTo(s).click(t);t();var c=utils.list("w2ifaces","w2ifaceid",null,["微软雅黑"]).load();$("<label for=w2iface>字体：</label>").appendTo(s);var d=$('<select id=w2iface style="font-size:200%">').appendTo(s).change(function(){c.load(d.prop("selectedIndex")),n()});c.list.forEach(function(e){$("<option>"+e+"</option>").appendTo(d)}),d.prop("selectedIndex",c.last),$("<span class=ge_sbtn>+</span>").appendTo(s).click(function(e){e=prompt("请输入字体名称："),e&&(c.load(c.push(e)),$("<option>").text(e).appendTo(d),d.val(e),n())}),$("<span class=ge_sbtn>-</span>").appendTo(s).click(function(e){e=d.prop("selectedIndex"),d.children(":eq("+e+")").remove(),c.pop(e),c.load(d.prop("selectedIndex")),n()}),initColorPanel();var u,f;utils.bindProp($("<input type=checkbox id=w2ipreview>").appendTo(s),"checked","w2ipreview",!1,n),$("<label for=w2ipreview>预览</label><br><label for=w2icolor>颜色：</label>").appendTo(s),$(u=utils.colorInput("w2icolor","w2icolor","#2222ff",n)).appendTo(s).addClass("ge_rsep"),$("<label for=w2isize>大小：</label>").appendTo(s),utils.bindProp($('<input type=number id=w2isize min=9 class=ge_rsep style="height:18px;width:40px;">').appendTo(s),"value","w2isize",22,n),utils.bindProp($("<input type=checkbox id=w2iabgclr>").appendTo(s),"checked","w2iabgclr",!1,n),$("<label for=w2iabgclr>背景色：</label>").appendTo(s),$(f=utils.colorInput("w2ibgclr","w2ibgclr","#efe4b0",n)).appendTo(s),$("<br>").appendTo(s),utils.bindProp($("<input type=checkbox id=w2ibold>").appendTo(s),"checked","w2ibold",!1,n),$("<label for=w2ibold class=ge_rsep>加粗</label>").appendTo(s),utils.bindProp($("<input type=checkbox id=w2iitalic>").appendTo(s),"checked","w2iitalic",!1,n),$("<label for=w2iitalic class=ge_rsep>倾斜</label>").appendTo(s),utils.bindProp($("<input type=checkbox id=w2ishadow>").appendTo(s),"checked","w2ishadow",!1,n),$("<label for=w2ishadow class=ge_rsep>阴影</label>").appendTo(s),utils.bindProp($("<input type=checkbox id=w2istroke>").appendTo(s),"checked","w2istroke",!1,n),$("<label for=w2istroke class=ge_rsep>镂空</label>").appendTo(s);var b=$('<span class="ge_sbtn ge_disabled" title="回到最后一次图化前的状态">撤销图化</span>').appendTo(s).click(function(){l&&(unsafeWindow.rich_postor._editor.editArea.innerHTML=l,l=null,b.addClass("ge_disabled"))});d.prop("selectedIndex",c.last),n()}();