// ==UserScript==
// @name	Tieba Common
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @description	百度贴吧用户脚本公共库 - Gerald倾情打造
// ==/UserScript==
var $=unsafeWindow.$,PageData=unsafeWindow.PageData,utils=function(){function t(t){var e;return e=t[1]?(t.charCodeAt(0)-55296<<10)+t.charCodeAt(1)+9216:t.charCodeAt(),t="x"+e.toString(16),/8964/.test(t)&&(t=e.toString()),"&#x26;#"+t+";"}return{cjk:"\u4e00-\u9fff",purl:"http://imgsrc.baidu.com/forum/pic/item/438dd519ebc4b745241c6ae8cffc1e1788821598.jpg",entity:function(e,n){return n="&[^;]+;|("+(n?n+"|":"")+"[\ud800-\udb7f][\udc00-\udfff])",n=new RegExp(n,"g"),e.replace(/(^|>)([^<]*)/g,function(e,o,i){return o+i.replace(n,function(e,n){return n?n.replace(/./g,t):e})})},hook:function(t,e,n,o){if(typeof t[e]!="function")return!1;if(!t[e].hooked){var i=t[e];t[e]=function(){var t,e=this,n=arguments,o=n.callee;return o.hook_before.forEach(function(t){t.apply(e,n)}),t=o.hook_func.apply(e,n),o.hook_after.forEach(function(o){t=o.apply(e,[t,n])||t}),t},t[e].hooked=!0,t[e].hook_after=[],t[e].hook_before=[],t[e].hook_func=i}o&&("function"==typeof o&&(o=[o]),o.forEach(function(n){t[e].hook_after.push(n)})),n&&("function"==typeof n&&(n=[n]),n.forEach(function(n){t[e].hook_before.push(n)}))},addStyle:function(t){return $('<style type="text/css">').html(t||"").appendTo("head")},getObj:function(t,e){var n=localStorage.getItem("ge_"+t);return n?e=JSON.parse(n):void 0!=e&&utils.setObj(t,e),e},setObj:function(t,e){return localStorage.setItem("ge_"+t,JSON.stringify(e)),e},innerText:function(t){return $("<div>").append(t.childNodes).html(function(t,e){return e.replace(/<br>(<\/p>)?|<\/p>/gi,"\n")}).text().replace(/\s+$/,"")},addButton:function(t,e,n,o){if(o||(o={}),n){var i,r=o.keys;for(r&&r.length||(r=["mousedown","mouseup"]),i=0;i<r.length;i++)if(e[r[i]]){e[r[i]].call(e,n);break}}return t=$(t),o.after?e.insertAfter(t.children(o.after)):o.before?e.insertBefore(t.children(o.before)):e.appendTo(t),e},addTButton:function(t,e){var n=$("div.tb-editor-toolbar"),o=n.children(":last");return o.position().left+o.outerWidth()+25>n.innerWidth()&&$("<div class=x>").appendTo(n),utils.addButton(n,t,e)},addSButton:function(t){var e=$("<input type=button>").appendTo(".pt_submit").addClass("subbtn_bg");return t&&e.val(t),e},addPopup:function(t,e,n){var o=$("<div>").addClass("ge_panel").appendTo(t).click(function(t){t.stopPropagation(),["A","BUTTON"].indexOf(t.target.tagName)>=0&&t.preventDefault()}).hide();return o.holder=t,o.onclose=function(){o.hide(),$(document).unbind("click",o.onclose)},o.onopen=function(e,i){e=t.offset(),i=o.button.offset(),o.show(),$(document).click(o.onclose),n&&n(o),o.css({left:Math.min(i.left-e.left-50,$(document.body).innerWidth()-e.left-o.outerWidth()-10),bottom:t.innerHeight()-i.top+e.top+5})},o.ontoggle=function(t){t.preventDefault(),o.button=$(t.target),o.is(":visible")?o.onclose():setTimeout(o.onopen,0)},e&&e.click(o.ontoggle),o},bindProp:function(t,e,n,o,i,r){return t.prop(e,utils.getObj(n,o)),r||(r=["change"]),r.forEach(function(o){t.bind(o,function(o){utils.setObj(n,this[e]),i&&t.each(function(t,e){i.call(e,o)})})}),t},list:function(t,e,n,o){var i={};return i.last=0,i.load=function(t,n){return void 0==t&&(t=e?utils.getObj(e,0):0),0>t||!i.length?t=0:t>=i.length&&(t=i.length-1),e&&!n&&utils.setObj(e,t),i.cur=i.list[i.last=t],i},i.push=function(t){return t||(t=n()),i.list.push(t),i.save(),i.length-1},i.pop=function(t){var e=i.list.splice(t,1)[0];return i.save(),i.load(t),e},i.save=function(){t&&utils.setObj(t,i.list),e&&utils.setObj(e,i.last)},i.list=t?utils.getObj(t,[]):[],i.__defineGetter__("length",function(){return i.list.length}),!i.length&&o&&(o.concat?(i.list=o.concat(),i.save()):i.push()),i},fixer:function(t){try{t()}catch(e){var n=$("<div>").appendTo("body").css({width:"120px",position:"fixed",left:0,top:0,display:"none","text-align":"center","z-index":999});$("<div>\u51fa\u9519\u4e86\uff01\u5982\u9700\u53cd\u9988\u8bf7\u590d\u5236\u4ee5\u4e0a\u4fe1\u606f</div>").appendTo(n).css("color","white").add($("<a href=http://gera2ld.blog.163.com/blog/static/1880172962013012101456740>\u70b9\u6b64\u53cd\u9988</a>").appendTo(n).css("color","yellow")).css({background:"purple",margin:"1px",padding:"10px","border-radius":"5px",display:"block"});var o=e.name+": "+e.message+"\n"+(e.stacktrace||e.stack);window.console&&console.log(o),n.prepend($('<textarea style="height:200px;">').val(o).mouseover(function(){this.select()})).show()}},notice:function(t,e){var n=GM_getValue("notice")||0;t>n&&(alert(e),GM_setValue("notice",t))}}}();unsafeWindow.__ge_style||(unsafeWindow.__ge_style=utils.addStyle(".x{clear:both}#edit_parent{position:relative;max-width:720px;}.ge_mask{background:#000;opacity:0.6;position:fixed;top:0;bottom:0;left:0;right:0;z-index:999;display:none;}.ge_panel{position:absolute;background:#eee;border:1px solid;padding:10px;border-radius:10px;z-index:888;}.ge_sbtn{background:#77f;color:white;border-radius:3px;border:1px solid;border:none;margin:2px;cursor:pointer;text-align:center;}span.ge_sbtn{padding:2px 3px;}.ge_disabled{background:gray;cursor:default;}.ge_rsep{margin-right:10px;}"),$(".tb-editor-editarea-wrapper").addClass("x"));