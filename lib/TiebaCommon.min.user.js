// ==UserScript==
// @name	Tieba Common
// @namespace	http://gera2ld.blog.163.com/
// @author	Gerald <gera2ld@163.com>
// @description	百度贴吧用户脚本公共库 - Gerald倾情打造
// ==/UserScript==
var $=unsafeWindow.$,PageData=unsafeWindow.PageData,utils={cjk:"\u4e00-\u9fff",purl:"http://imgsrc.baidu.com/forum/pic/item/438dd519ebc4b745241c6ae8cffc1e1788821598.jpg",hookFunc:function(e,t,o){var n=e[t];n.hooked||(e[t]=function(){var e,t=this,o=arguments,n=o.callee;return n.hook_before.forEach(function(e){e.apply(t,o)}),e=n.hook_func.apply(t,o),n.hook_after.forEach(function(n){e=n.apply(t,[e,o])||e}),e},e[t].hook_func=n,n=e[t],n.hooked=!0,n.hook_after=[],n.hook_before=[]),e=n.hook_after,(t=o.after)&&(t.concat?n.hook_after=e.concat(t):e.push(t)),e=n.hook_before,(t=o.before)&&(t.concat?n.hook_before=e.concat(t):e.push(t))},hook:function(e,t,o,n){return utils.hookFunc(e,t,{before:o,after:n})},addStyle:function(e){return $('<style type="text/css">').html(e||"").appendTo("head")},getObj:function(e,t){var o=localStorage.getItem("ge_"+e);return o?t=JSON.parse(o):void 0!=t&&utils.setObj(e,t),t},setObj:function(e,t){return localStorage.setItem("ge_"+e,JSON.stringify(t)),t},innerText:function(e){return $("<div>").append(e.childNodes).html(function(e,t){return t.replace(/<br>(<\/p>)?|<\/p>/gi,"\n")}).text().replace(/\s+$/,"")},addButton:function(e,t,o,n){if(n||(n={}),o){var a,i=n.keys;for(i&&i.length||(i=["mousedown","mouseup"]),a=0;a<i.length;a++)if(t[i[a]]){t[i[a]].call(t,o);break}}return e=$(e),n.after?t.insertAfter(e.children(n.after)):n.before?t.insertBefore(e.children(n.before)):t.appendTo(e),t},addTButton:function(e,t){var o=$("div.tb-editor-toolbar"),n=o.children(":last");return n.position().left+n.outerWidth()+25>o.innerWidth()&&$("<div class=x>").appendTo(o),utils.addButton(o,e,t)},addSButton:function(e){var t=$("<input type=button>").appendTo(".pt_submit").addClass("subbtn_bg");return e&&t.val(e),t},addPopup:function(e,t,o){var n=$('<div class=ge_panel_p title="">').appendTo(e).click(function(e){e.stopPropagation(),["A","BUTTON"].indexOf(e.target.tagName)>=0&&e.preventDefault()}).hide();return n.holder=e,n.arrow=$("<div class=ge_arrow>").appendTo(n).html("<span>\u25c6</span><span>\u25c6</span>"),n.panel=$("<div class=ge_panel>").appendTo(n),n.onclose=function(){n.hide(),$(document).unbind("click",n.onclose)},n.onopen=function(t,a,i){t=e.offset(),a=n.button.offset(),n.show(),$(document).click(n.onclose),o&&o(n),i=Math.min(a.left-t.left-50,$(document.body).innerWidth()-t.left-n.panel.outerWidth()-20),n.css({left:i,bottom:e.innerHeight()-a.top+t.top}),n.arrow.css({left:a.left-t.left-i})},n.ontoggle=function(e){e.preventDefault(),n.button=$(e.target),n.is(":visible")?n.onclose():setTimeout(n.onopen,0)},t&&t.click(n.ontoggle),n},bindProp:function(e,t,o,n,a,i){return e.prop(t,utils.getObj(o,n)),i||(i=["change"]),i.forEach(function(n){e.bind(n,function(n){utils.setObj(o,this[t]),a&&e.each(function(e,t){a.call(t,n)})})}),e},list:function(e,t,o,n){var a={};return a.last=0,a.load=function(e,o){return void 0==e&&(e=t?utils.getObj(t,0):0),0>e||!a.length?e=0:e>=a.length&&(e=a.length-1),t&&!o&&utils.setObj(t,e),a.cur=a.list[a.last=e],a},a.push=function(e){return e||(e=o()),a.list.push(e),a.save(),a.length-1},a.pop=function(e){var t=a.list.splice(e,1)[0];return a.save(),a.load(e),t},a.save=function(){e&&utils.setObj(e,a.list),t&&utils.setObj(t,a.last)},a.list=e?utils.getObj(e,[]):[],a.__defineGetter__("length",function(){return a.list.length}),!a.length&&n&&(n.concat?(a.list=n.concat(),a.save()):a.push()),a},fixer:function(e){try{e()}catch(t){var o=$("<div>").appendTo("body").css({width:"120px",position:"fixed",left:0,top:0,display:"none","text-align":"center","z-index":999});$("<div>\u51fa\u9519\u4e86\uff01\u5982\u9700\u53cd\u9988\u8bf7\u590d\u5236\u4ee5\u4e0a\u4fe1\u606f</div>").appendTo(o).css("color","white").add($("<a href=http://gera2ld.blog.163.com/blog/static/1880172962013012101456740>\u70b9\u6b64\u53cd\u9988</a>").appendTo(o).css("color","yellow")).css({background:"purple",margin:"1px",padding:"10px","border-radius":"5px",display:"block"});var n=t.name+": "+t.message+"\n"+(t.stacktrace||t.stack);window.console&&console.log(n),o.prepend($('<textarea style="height:200px;">').val(n).mouseover(function(){this.select()})).show()}},notice:function(e,t){var o=GM_getValue("notice")||0;e>o&&(alert(t),GM_setValue("notice",e))}};unsafeWindow.__ge_style||(unsafeWindow.__ge_style=utils.addStyle(".x{clear:both}#edit_parent{position:relative;max-width:720px;}.ge_mask{background:#000;opacity:0.6;position:fixed;top:0;bottom:0;left:0;right:0;z-index:999;display:none;}.ge_panel_p{position:relative;z-index:888;}.ge_panel{position:absolute;background:#eee;border:1px solid black;padding:10px;border-radius:10px;z-index:888;bottom:0;}.ge_arrow{position:relative;}.ge_arrow>span{position:absolute;line-height:1;bottom:-0.5em;}.ge_arrow>span:last-child{color:#eee;bottom:-0.4em;z-index:999;}.ge_sbtn{background:#77f;color:white;border-radius:3px;border:1px solid;border:none;margin:2px;cursor:pointer;text-align:center;}span.ge_sbtn{padding:2px 3px;}.ge_disabled{background:gray;cursor:default;}.ge_rsep{margin-right:10px;}"),$(".tb-editor-editarea-wrapper").addClass("x"));